/*
 * typeahead.js
 * https://github.com/twitter/typeahead
 * Copyright 2013 Twitter, Inc. and other contributors; Licensed MIT
 */

var Dataset=function(){function e(e){utils.bindAll(this),this.storage=new PersistentStorage(e.name),this.adjacencyList={},this.itemHash={},this.name=e.name,this.resetDataOnProtocolSwitch=e.resetDataOnProtocolSwitch||!1,this.queryUrl=e.remote,this.transport=e.transport,this.limit=e.limit||10,this._customMatcher=e.matcher||null,this._customRanker=e.ranker||null,this._ttl_ms=e.ttl_ms||2592e5,this.keys={version:"version",protocol:"protocol",itemHash:"itemHash",adjacencyList:"adjacencyList"},e.local&&this._processLocalData(e.local),e.prefetch&&this._loadPrefetchData(e.prefetch)}return utils.mixin(e.prototype,{_processLocalData:function(e){e&&this._mergeProcessedData(this._processData(e))},_loadPrefetchData:function(e){function t(e){var t=n._processData(e),r=t.itemHash,i=t.adjacencyList;n.storage.set(n.keys.itemHash,r,n._ttl_ms),n.storage.set(n.keys.adjacencyList,i,n._ttl_ms),n.storage.set(n.keys.version,VERSION,n._ttl_ms),n.storage.set(n.keys.protocol,utils.getProtocol(),n._ttl_ms),n._mergeProcessedData(t)}var n=this,r=this.storage.get(this.keys.itemHash),i=this.storage.get(this.keys.adjacencyList),o=this.storage.get(this.keys.protocol),s=this.storage.get(this.keys.version),a=s!==VERSION||o!==utils.getProtocol();r&&i&&!a?this._mergeProcessedData({itemHash:r,adjacencyList:i}):$.getJSON(e).done(t)},_processData:function(e){var t={},n={};return utils.each(e,function(e,r){var i;utils.isString(r)&&(r={value:r,tokens:utils.tokenizeText(r)}),r.tokens=utils.map(r.tokens||[],function(e){return e.toLowerCase()}),t[i=utils.getUniqueId(r.value)]=r,utils.each(r.tokens,function(e,t){var r=t.charAt(0),o=n[r]||(n[r]=[i]);!~utils.indexOf(o,i)&&o.push(i)})}),{itemHash:t,adjacencyList:n}},_mergeProcessedData:function(e){var t=this;utils.mixin(this.itemHash,e.itemHash),utils.each(e.adjacencyList,function(e,n){var r=t.adjacencyList[e];t.adjacencyList[e]=r?r.concat(n):n})},_getPotentiallyMatchingIds:function(e){var t=[],n=[];if(utils.map(e,utils.bind(function(e){var t=this.adjacencyList[e.charAt(0)];t&&n.push(t)},this)),1===n.length)return n[0];var r=[];$.each(n,function(e,t){r.push(t.length)});var i=utils.indexOf(r,Math.min.apply(null,r))||0,o=n[i]||[];return t=utils.map(o,function(e){var t=utils.every(n,function(t){return utils.indexOf(t,e)>-1});return t?e:void 0})},_getItemsFromIds:function(e){var t=[];return utils.map(e,utils.bind(function(e){var n=this.itemHash[e];n&&t.push(n)},this)),t},_matcher:function(e){if(this._customMatcher){var t=this._customMatcher;return function(e){return t(e)}}return function(t){var n=t.tokens,r=utils.every(e,function(e){var t=utils.filter(n,function(t){return 0===t.indexOf(e)});return t.length});return r?t:void 0}},_compareItems:function(e,t,n){var r=e.score_boost?e.score_boost:0,i=t.score_boost?t.score_boost:0,o=e.score?e.score:0,s=t.score?t.score:0;return n?t.weight+i-(e.weight+r):s+i-(o+r)},_ranker:function(e,t){if(this._customRanker)return this._customRanker(e,t);var n=e.weight&&0!==e.weight,r=t.weight&&0!==t.weight;return n&&!r?-1:r&&!n?1:n&&r?this._compareItems(e,t,!0):this._compareItems(e,t,!1)},_processRemoteSuggestions:function(e,t){var n=this;return function(r){utils.each(r,function(e,r){var i=!1;return r=utils.isString(r)?{value:r}:r,utils.each(t,function(e,t){return r.value===t.value?(i=!0,!1):void 0}),!i&&t.push(r),t.length<n.limit}),e&&e(t)}},getSuggestions:function(e,t){var n=utils.tokenizeQuery(e),r=this._getPotentiallyMatchingIds(n),i=this._getItemsFromIds(r),o=utils.filter(i,this._matcher(n));o.sort(this._ranker),t&&t(o),o.length<this.limit&&this.queryUrl&&this.transport.get(this.queryUrl,e,this._processRemoteSuggestions(t,o))}}),e}();