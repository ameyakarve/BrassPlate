(function(){var e,t,n,r,i,o,a,s,u,l,c,f,p,d,h,m,g,v,y=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},b=[].slice;for(exports.Rewriter=function(){function e(){}return e.prototype.rewrite=function(e){return this.tokens=e,this.removeLeadingNewlines(),this.removeMidExpressionNewlines(),this.closeOpenCalls(),this.closeOpenIndexes(),this.addImplicitIndentation(),this.tagPostfixConditionals(),this.addImplicitBraces(),this.addImplicitParentheses(),this.tokens},e.prototype.scanTokens=function(e){var t,n,r;for(r=this.tokens,t=0;n=r[t];)t+=e.call(this,n,t,r);return!0},e.prototype.detectEnd=function(e,t,i){var o,a,s,u,l;for(s=this.tokens,o=0;a=s[e];){if(0===o&&t.call(this,a,e))return i.call(this,a,e);if(!a||0>o)return i.call(this,a,e-1);u=a[0],y.call(r,u)>=0?o+=1:(l=a[0],y.call(n,l)>=0&&(o-=1)),e+=1}return e-1},e.prototype.removeLeadingNewlines=function(){var e,t,n,r,i;for(i=this.tokens,e=n=0,r=i.length;r>n&&(t=i[e][0],"TERMINATOR"===t);e=++n);return e?this.tokens.splice(0,e):void 0},e.prototype.removeMidExpressionNewlines=function(){return this.scanTokens(function(e,n,r){var i;return"TERMINATOR"===e[0]&&(i=this.tag(n+1),y.call(t,i)>=0)?(r.splice(n,1),0):1})},e.prototype.closeOpenCalls=function(){var e,t;return t=function(e,t){var n;return")"===(n=e[0])||"CALL_END"===n||"OUTDENT"===e[0]&&")"===this.tag(t-1)},e=function(e,t){return this.tokens["OUTDENT"===e[0]?t-1:t][0]="CALL_END"},this.scanTokens(function(n,r){return"CALL_START"===n[0]&&this.detectEnd(r+1,t,e),1})},e.prototype.closeOpenIndexes=function(){var e,t;return t=function(e){var t;return"]"===(t=e[0])||"INDEX_END"===t},e=function(e){return e[0]="INDEX_END"},this.scanTokens(function(n,r){return"INDEX_START"===n[0]&&this.detectEnd(r+1,t,e),1})},e.prototype.addImplicitBraces=function(){var e,t,i,o,s,u,l,f;return o=[],s=null,f=null,i=!0,u=0,l=0,t=function(e,t){var n,r,o,s,u,p;return u=this.tokens.slice(t+1,t+3+1||9e9),n=u[0],s=u[1],o=u[2],"HERECOMMENT"===(null!=n?n[0]:void 0)?!1:(r=e[0],y.call(c,r)>=0&&(i=!1),("TERMINATOR"===r||"OUTDENT"===r||y.call(a,r)>=0&&i&&!(1===t-l))&&(!f&&","!==this.tag(t-1)||!(":"===(null!=s?s[0]:void 0)||"@"===(null!=n?n[0]:void 0)&&":"===(null!=o?o[0]:void 0)))||","===r&&n&&"IDENTIFIER"!==(p=n[0])&&"NUMBER"!==p&&"STRING"!==p&&"@"!==p&&"TERMINATOR"!==p&&"OUTDENT"!==p)},e=function(e,t){var n;return n=this.generate("}","}",e[2]),this.tokens.splice(t,0,n)},this.scanTokens(function(a,u,p){var d,h,m,g,v,b,w,_;if(w=g=a[0],y.call(r,w)>=0)return o.push(["INDENT"===g&&"{"===this.tag(u-1)?"{":g,u]),1;if(y.call(n,g)>=0)return s=o.pop(),1;if(":"!==g||":"!==(d=this.tag(u-2))&&"{"===(null!=(_=o[o.length-1])?_[0]:void 0))return 1;for(i=!0,l=u+1,o.push(["{"]),h="@"===d?u-2:u-1;"HERECOMMENT"===this.tag(h-2);)h-=2;return m=this.tag(h-1),f=!m||y.call(c,m)>=0,b=new String("{"),b.generated=!0,v=this.generate("{",b,a[2]),p.splice(h,0,v),this.detectEnd(u+2,t,e),2})},e.prototype.addImplicitParentheses=function(){var e,t,n,r,l;return n=l=r=!1,t=function(e,t){var n,o,s,u;return o=e[0],!l&&e.fromThen?!0:(("IF"===o||"ELSE"===o||"CATCH"===o||"->"===o||"=>"===o||"CLASS"===o)&&(l=!0),("IF"===o||"ELSE"===o||"SWITCH"===o||"TRY"===o||"="===o)&&(r=!0),"."!==o&&"?."!==o&&"::"!==o||"OUTDENT"!==this.tag(t-1)?!e.generated&&","!==this.tag(t-1)&&(y.call(a,o)>=0||"INDENT"===o&&!r)&&("INDENT"!==o||"CLASS"!==(s=this.tag(t-2))&&"EXTENDS"!==s&&(u=this.tag(t-1),0>y.call(i,u))&&!((n=this.tokens[t+1])&&n.generated&&"{"===n[0])):!0)},e=function(e,t){return this.tokens.splice(t,0,this.generate("CALL_END",")",e[2]))},this.scanTokens(function(i,a,f){var p,d,h,m,g,v,b,w;return g=i[0],("CLASS"===g||"IF"===g||"FOR"===g||"WHILE"===g)&&(n=!0),v=f.slice(a-1,a+1+1||9e9),m=v[0],d=v[1],h=v[2],p=!n&&"INDENT"===g&&h&&h.generated&&"{"===h[0]&&m&&(b=m[0],y.call(s,b)>=0),l=!1,r=!1,y.call(c,g)>=0&&(n=!1),m&&!m.spaced&&"?"===g&&(i.call=!0),i.fromThen?1:p||(null!=m?m.spaced:void 0)&&(m.call||(w=m[0],y.call(s,w)>=0))&&(y.call(o,g)>=0||!i.spaced&&!i.newLine&&y.call(u,g)>=0)?(f.splice(a,0,this.generate("CALL_START","(",i[2])),this.detectEnd(a+1,t,e),"?"===m[0]&&(m[0]="FUNC_EXIST"),2):1})},e.prototype.addImplicitIndentation=function(){var e,t,n,r,i;return i=n=r=null,t=function(e){var t;return";"!==e[1]&&(t=e[0],y.call(f,t)>=0)&&!("ELSE"===e[0]&&"IF"!==i&&"THEN"!==i)},e=function(e,t){return this.tokens.splice(","===this.tag(t-1)?t-1:t,0,r)},this.scanTokens(function(o,a,s){var u,l,c;return u=o[0],"TERMINATOR"===u&&"THEN"===this.tag(a+1)?(s.splice(a,1),0):"ELSE"===u&&"OUTDENT"!==this.tag(a-1)?(s.splice.apply(s,[a,0].concat(b.call(this.indentation(o)))),2):"CATCH"!==u||"OUTDENT"!==(l=this.tag(a+2))&&"TERMINATOR"!==l&&"FINALLY"!==l?y.call(p,u)>=0&&"INDENT"!==this.tag(a+1)&&("ELSE"!==u||"IF"!==this.tag(a+1))?(i=u,c=this.indentation(o,!0),n=c[0],r=c[1],"THEN"===i&&(n.fromThen=!0),s.splice(a+1,0,n),this.detectEnd(a+2,t,e),"THEN"===u&&s.splice(a,1),1):1:(s.splice.apply(s,[a+2,0].concat(b.call(this.indentation(o)))),4)})},e.prototype.tagPostfixConditionals=function(){var e,t,n;return n=null,t=function(e){var t;return"TERMINATOR"===(t=e[0])||"INDENT"===t},e=function(e){return"INDENT"!==e[0]||e.generated&&!e.fromThen?n[0]="POST_"+n[0]:void 0},this.scanTokens(function(r,i){return"IF"!==r[0]?1:(n=r,this.detectEnd(i+1,t,e),1)})},e.prototype.indentation=function(e,t){var n,r;return null==t&&(t=!1),n=["INDENT",2,e[2]],r=["OUTDENT",2,e[2]],t&&(n.generated=r.generated=!0),[n,r]},e.prototype.generate=function(e,t,n){var r;return r=[e,t,n],r.generated=!0,r},e.prototype.tag=function(e){var t;return null!=(t=this.tokens[e])?t[0]:void 0},e}(),e=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]],exports.INVERSES=l={},r=[],n=[],m=0,g=e.length;g>m;m++)v=e[m],d=v[0],h=v[1],r.push(l[h]=d),n.push(l[d]=h);t=["CATCH","WHEN","ELSE","FINALLY"].concat(n),s=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"],o=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","@","->","=>","[","(","{","--","++"],u=["+","-"],i=["->","=>","{","[",","],a=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"],p=["ELSE","->","=>","TRY","FINALLY","THEN"],f=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"],c=["TERMINATOR","INDENT","OUTDENT"]}).call(this);