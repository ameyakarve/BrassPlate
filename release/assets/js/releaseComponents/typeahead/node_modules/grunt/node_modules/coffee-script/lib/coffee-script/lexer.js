(function(){var e,t,n,r,i,o,a,s,u,l,c,f,d,p,h,m,g,v,y,b,_,w,x,k,E,q,S,A,T,j,C,N,O,M,L,D,F,I,R,B,P,$,H,z,U,W,V,G,X=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};V=require("./rewriter"),L=V.Rewriter,g=V.INVERSES,G=require("./helpers"),H=G.count,W=G.starts,$=G.compact,U=G.last,exports.Lexer=k=function(){function e(){}return e.prototype.tokenize=function(e,t){var n,r;for(null==t&&(t={}),P.test(e)&&(e="\n"+e),e=e.replace(/\r/g,"").replace(R,""),this.code=e,this.line=t.line||0,this.indent=0,this.indebt=0,this.outdebt=0,this.indents=[],this.ends=[],this.tokens=[],n=0;this.chunk=e.slice(n);)n+=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken();return this.closeIndentation(),(r=this.ends.pop())&&this.error("missing "+r),t.rewrite===!1?this.tokens:(new L).rewrite(this.tokens)},e.prototype.identifierToken=function(){var e,t,n,a,s,u,l,c,f;return(s=h.exec(this.chunk))?(a=s[0],n=s[1],e=s[2],"own"===n&&"FOR"===this.tag()?(this.token("OWN",n),n.length):(t=e||(u=U(this.tokens))&&("."===(c=u[0])||"?."===c||"::"===c||!u.spaced&&"@"===u[0]),l="IDENTIFIER",!t&&(X.call(b,n)>=0||X.call(o,n)>=0)&&(l=n.toUpperCase(),"WHEN"===l&&(f=this.tag(),X.call(_,f)>=0)?l="LEADING_WHEN":"FOR"===l?this.seenFor=!0:"UNLESS"===l?l="IF":X.call(B,l)>=0?l="UNARY":X.call(O,l)>=0&&("INSTANCEOF"!==l&&this.seenFor?(l="FOR"+l,this.seenFor=!1):(l="RELATION","!"===this.value()&&(this.tokens.pop(),n="!"+n)))),X.call(y,n)>=0&&(t?(l="IDENTIFIER",n=new String(n),n.reserved=!0):X.call(M,n)>=0&&this.error('reserved word "'+n+'"')),t||(X.call(r,n)>=0&&(n=i[n]),l=function(){switch(n){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return l}}()),this.token(l,n),e&&this.token(":",":"),a.length)):0},e.prototype.numberToken=function(){var e,t,n,r,i;return(n=j.exec(this.chunk))?(r=n[0],/^0[BOX]/.test(r)?this.error("radix prefix '"+r+"' must be lowercase"):/E/.test(r)&&!/^0x/.test(r)?this.error("exponential notation '"+r+"' must be indicated with a lowercase 'e'"):/^0\d*[89]/.test(r)?this.error("decimal literal '"+r+"' must not be prefixed with '0'"):/^0\d+/.test(r)&&this.error("octal literal '"+r+"' must be prefixed with '0o'"),t=r.length,(i=/^0o([0-7]+)/.exec(r))&&(r="0x"+parseInt(i[1],8).toString(16)),(e=/^0b([01]+)/.exec(r))&&(r="0x"+parseInt(e[1],2).toString(16)),this.token("NUMBER",r),t):0},e.prototype.stringToken=function(){var e,t,n;switch(this.chunk.charAt(0)){case"'":if(!(e=F.exec(this.chunk)))return 0;this.token("STRING",(n=e[0]).replace(q,"\\\n"));break;case'"':if(!(n=this.balancedString(this.chunk,'"')))return 0;n.indexOf("#{",1)>0?this.interpolateString(n.slice(1,-1)):this.token("STRING",this.escapeLines(n));break;default:return 0}return(t=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(n))&&this.error("octal escape sequences "+n+" are not allowed"),this.line+=H(n,"\n"),n.length},e.prototype.heredocToken=function(){var e,t,n,r;return(n=l.exec(this.chunk))?(t=n[0],r=t.charAt(0),e=this.sanitizeHeredoc(n[2],{quote:r,indent:null}),'"'===r&&e.indexOf("#{")>=0?this.interpolateString(e,{heredoc:!0}):this.token("STRING",this.makeString(e,r,!0)),this.line+=H(t,"\n"),t.length):0},e.prototype.commentToken=function(){var e,t,n;return(n=this.chunk.match(a))?(e=n[0],t=n[1],t&&this.token("HERECOMMENT",this.sanitizeHeredoc(t,{herecomment:!0,indent:Array(this.indent+1).join(" ")})),this.line+=H(e,"\n"),e.length):0},e.prototype.jsToken=function(){var e,t;return"`"===this.chunk.charAt(0)&&(e=v.exec(this.chunk))?(this.token("JS",(t=e[0]).slice(1,-1)),t.length):0},e.prototype.regexToken=function(){var e,t,n,r,i,o,a;return"/"!==this.chunk.charAt(0)?0:(n=d.exec(this.chunk))?(t=this.heregexToken(n),this.line+=H(n[0],"\n"),t):(r=U(this.tokens),r&&(o=r[0],X.call(r.spaced?A:T,o)>=0)?0:(n=N.exec(this.chunk))?(a=n,n=a[0],i=a[1],e=a[2],"/*"===i.slice(0,2)&&this.error("regular expressions cannot begin with `*`"),"//"===i&&(i="/(?:)/"),this.token("REGEX",""+i+e),n.length):0)},e.prototype.heregexToken=function(e){var t,n,r,i,o,a,s,u,l,c,f,d,h;if(r=e[0],t=e[1],n=e[2],0>t.indexOf("#{"))return i=t.replace(p,"").replace(/\//g,"\\/"),i.match(/^\*/)&&this.error("regular expressions cannot begin with `*`"),this.token("REGEX","/"+(i||"(?:)")+"/"+n),r.length;for(this.token("IDENTIFIER","RegExp"),this.tokens.push(["CALL_START","("]),a=[],c=this.interpolateString(t,{regex:!0}),u=0,l=c.length;l>u;u++){if(f=c[u],o=f[0],s=f[1],"TOKENS"===o)a.push.apply(a,s);else{if(!(s=s.replace(p,"")))continue;s=s.replace(/\\/g,"\\\\"),a.push(["STRING",this.makeString(s,'"',!0)])}a.push(["+","+"])}return a.pop(),"STRING"!==(null!=(d=a[0])?d[0]:void 0)&&this.tokens.push(["STRING",'""'],["+","+"]),(h=this.tokens).push.apply(h,a),n&&this.tokens.push([",",","],["STRING",'"'+n+'"']),this.token(")",")"),r.length},e.prototype.lineToken=function(){var e,t,n,r,i,o;if(!(n=S.exec(this.chunk)))return 0;if(t=n[0],this.line+=H(t,"\n"),this.seenFor=!1,i=U(this.tokens,1),o=t.length-1-t.lastIndexOf("\n"),r=this.unfinished(),o-this.indebt===this.indent)return r?this.suppressNewlines():this.newlineToken(),t.length;if(o>this.indent){if(r)return this.indebt=o-this.indent,this.suppressNewlines(),t.length;e=o-this.indent+this.outdebt,this.token("INDENT",e),this.indents.push(e),this.ends.push("OUTDENT"),this.outdebt=this.indebt=0}else this.indebt=0,this.outdentToken(this.indent-o,r);return this.indent=o,t.length},e.prototype.outdentToken=function(e,t){for(var n,r;e>0;)r=this.indents.length-1,void 0===this.indents[r]?e=0:this.indents[r]===this.outdebt?(e-=this.outdebt,this.outdebt=0):this.indents[r]<this.outdebt?(this.outdebt-=this.indents[r],e-=this.indents[r]):(n=this.indents.pop()-this.outdebt,e-=n,this.outdebt=0,this.pair("OUTDENT"),this.token("OUTDENT",n));for(n&&(this.outdebt-=e);";"===this.value();)this.tokens.pop();return"TERMINATOR"===this.tag()||t||this.token("TERMINATOR","\n"),this},e.prototype.whitespaceToken=function(){var e,t,n;return(e=P.exec(this.chunk))||(t="\n"===this.chunk.charAt(0))?(n=U(this.tokens),n&&(n[e?"spaced":"newLine"]=!0),e?e[0].length:0):0},e.prototype.newlineToken=function(){for(;";"===this.value();)this.tokens.pop();return"TERMINATOR"!==this.tag()&&this.token("TERMINATOR","\n"),this},e.prototype.suppressNewlines=function(){return"\\"===this.value()&&this.tokens.pop(),this},e.prototype.literalToken=function(){var e,r,i,o,a,l,c,f;if((e=C.exec(this.chunk))?(o=e[0],n.test(o)&&this.tagParameters()):o=this.chunk.charAt(0),i=o,r=U(this.tokens),"="===o&&r&&(!r[1].reserved&&(a=r[1],X.call(y,a)>=0)&&this.error('reserved word "'+this.value()+"\" can't be assigned"),"||"===(l=r[1])||"&&"===l))return r[0]="COMPOUND_ASSIGN",r[1]+="=",o.length;if(";"===o)this.seenFor=!1,i="TERMINATOR";else if(X.call(E,o)>=0)i="MATH";else if(X.call(s,o)>=0)i="COMPARE";else if(X.call(u,o)>=0)i="COMPOUND_ASSIGN";else if(X.call(B,o)>=0)i="UNARY";else if(X.call(D,o)>=0)i="SHIFT";else if(X.call(x,o)>=0||"?"===o&&(null!=r?r.spaced:void 0))i="LOGIC";else if(r&&!r.spaced)if("("===o&&(c=r[0],X.call(t,c)>=0))"?"===r[0]&&(r[0]="FUNC_EXIST"),i="CALL_START";else if("["===o&&(f=r[0],X.call(m,f)>=0))switch(i="INDEX_START",r[0]){case"?":r[0]="INDEX_SOAK"}switch(o){case"(":case"{":case"[":this.ends.push(g[o]);break;case")":case"}":case"]":this.pair(o)}return this.token(i,o),o.length},e.prototype.sanitizeHeredoc=function(e,t){var n,r,i,o,a;if(i=t.indent,r=t.herecomment){if(c.test(e)&&this.error('block comment cannot contain "*/", starting'),0>=e.indexOf("\n"))return e}else for(;o=f.exec(e);)n=o[1],(null===i||(a=n.length)>0&&i.length>a)&&(i=n);return i&&(e=e.replace(RegExp("\\n"+i,"g"),"\n")),r||(e=e.replace(/^\n/,"")),e},e.prototype.tagParameters=function(){var e,t,n,r;if(")"!==this.tag())return this;for(t=[],r=this.tokens,e=r.length,r[--e][0]="PARAM_END";n=r[--e];)switch(n[0]){case")":t.push(n);break;case"(":case"CALL_START":if(!t.length)return"("===n[0]?(n[0]="PARAM_START",this):this;t.pop()}return this},e.prototype.closeIndentation=function(){return this.outdentToken(this.indent)},e.prototype.balancedString=function(e,t){var n,r,i,o,a,s,u,l;for(n=0,s=[t],r=u=1,l=e.length;l>=1?l>u:u>l;r=l>=1?++u:--u)if(n)--n;else{switch(i=e.charAt(r)){case"\\":++n;continue;case t:if(s.pop(),!s.length)return e.slice(0,r+1||9e9);t=s[s.length-1];continue}"}"!==t||'"'!==i&&"'"!==i?"}"===t&&"/"===i&&(o=d.exec(e.slice(r))||N.exec(e.slice(r)))?n+=o[0].length-1:"}"===t&&"{"===i?s.push(t="}"):'"'===t&&"#"===a&&"{"===i&&s.push(t="}"):s.push(t=i),a=i}return this.error("missing "+s.pop()+", starting")},e.prototype.interpolateString=function(t,n){var r,i,o,a,s,u,l,c,f,d,p,h,m,g,v,y,b,_;for(null==n&&(n={}),i=n.heredoc,d=n.regex,h=[],f=0,o=-1;l=t.charAt(o+=1);)"\\"!==l?"#"===l&&"{"===t.charAt(o+1)&&(r=this.balancedString(t.slice(o+1),"}"))&&(o>f&&h.push(["NEOSTRING",t.slice(f,o)]),a=r.slice(1,-1),a.length&&(c=(new e).tokenize(a,{line:this.line,rewrite:!1}),c.pop(),"TERMINATOR"===(null!=(y=c[0])?y[0]:void 0)&&c.shift(),(u=c.length)&&(u>1&&(c.unshift(["(","(",this.line]),c.push([")",")",this.line])),h.push(["TOKENS",c]))),o+=r.length,f=o+1):o+=1;if(o>f&&t.length>f&&h.push(["NEOSTRING",t.slice(f)]),d)return h;if(!h.length)return this.token("STRING",'""');for("NEOSTRING"!==h[0][0]&&h.unshift(["",""]),(s=h.length>1)&&this.token("(","("),o=g=0,v=h.length;v>g;o=++g)b=h[o],p=b[0],m=b[1],o&&this.token("+","+"),"TOKENS"===p?(_=this.tokens).push.apply(_,m):this.token("STRING",this.makeString(m,'"',i));return s&&this.token(")",")"),h},e.prototype.pair=function(e){var t,n;return e!==(n=U(this.ends))?("OUTDENT"!==n&&this.error("unmatched "+e),this.indent-=t=U(this.indents),this.outdentToken(t,!0),this.pair(e)):this.ends.pop()},e.prototype.token=function(e,t){return this.tokens.push([e,t,this.line])},e.prototype.tag=function(e,t){var n;return(n=U(this.tokens,e))&&(t?n[0]=t:n[0])},e.prototype.value=function(e,t){var n;return(n=U(this.tokens,e))&&(t?n[1]=t:n[1])},e.prototype.unfinished=function(){var e;return w.test(this.chunk)||"\\"===(e=this.tag())||"."===e||"?."===e||"UNARY"===e||"MATH"===e||"+"===e||"-"===e||"SHIFT"===e||"RELATION"===e||"COMPARE"===e||"LOGIC"===e||"THROW"===e||"EXTENDS"===e},e.prototype.escapeLines=function(e,t){return e.replace(q,t?"\\n":"")},e.prototype.makeString=function(e,t,n){return e?(e=e.replace(/\\([\s\S])/g,function(e,n){return"\n"===n||n===t?n:e}),e=e.replace(RegExp(""+t,"g"),"\\$&"),t+this.escapeLines(e,n)+t):t+t},e.prototype.error=function(e){throw SyntaxError(""+e+" on line "+(this.line+1))},e}(),b=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"],o=["undefined","then","unless","until","loop","of","by","when"],i={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"},r=function(){var e;e=[];for(z in i)e.push(z);return e}(),o=o.concat(r),M=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","let","package","private","protected","public","static","yield"],I=["arguments","eval"],y=b.concat(M).concat(I),exports.RESERVED=M.concat(b).concat(o).concat(I),exports.STRICT_PROSCRIBED=I,h=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/,j=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i,l=/^("""|''')([\s\S]*?)(?:\n[^\n\S]*)?\1/,C=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?\.|\.{2,3})/,P=/^[^\n\S]+/,a=/^###([^#][\s\S]*?)(?:###[^\n\S]*|(?:###)?$)|^(?:\s*#(?!##[^#]).*)+/,n=/^[-=]>/,S=/^(?:\n[^\n\S]*)+/,F=/^'[^\\']*(?:\\.[^\\']*)*'/,v=/^`[^\\`]*(?:\\.[^\\`]*)*`/,N=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/,d=/^\/{3}([\s\S]+?)\/{3}([imgy]{0,4})(?!\w)/,p=/\s+(?:#.*)?/g,q=/\n/g,f=/\n+([^\n\S]*)/g,c=/\*\//,w=/^\s*(?:,|\??\.(?![.\d])|::)/,R=/\s+$/,u=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="],B=["!","~","NEW","TYPEOF","DELETE","DO"],x=["&&","||","&","|","^"],D=["<<",">>",">>>"],s=["==","!=","<",">","<=",">="],E=["*","/","%"],O=["IN","OF","INSTANCEOF"],e=["TRUE","FALSE"],A=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--","]"],T=A.concat(")","}","THIS","IDENTIFIER","STRING"),t=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"],m=t.concat("NUMBER","BOOL","NULL","UNDEFINED"),_=["INDENT","OUTDENT","TERMINATOR"]}).call(this);