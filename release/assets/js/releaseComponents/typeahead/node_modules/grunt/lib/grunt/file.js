/*
 * grunt
 * http://gruntjs.com/
 *
 * Copyright (c) 2012 "Cowboy" Ben Alman
 * Licensed under the MIT license.
 * https://github.com/gruntjs/grunt/blob/master/LICENSE-MIT
 */

var grunt=require("../grunt"),fs=require("fs"),path=require("path"),file=module.exports={};file.glob=require("glob"),file.minimatch=require("minimatch"),file.findup=require("findup-sync");var YAML=require("js-yaml"),rimraf=require("rimraf"),iconv=require("iconv-lite"),win32="win32"===process.platform,unixifyPath=function(e){return win32?e.replace(/\\/g,"/"):e};file.setBase=function(){var e=path.join.apply(path,arguments);process.chdir(e)};var processPatterns=function(e,t){var n=[];return grunt.util._.flatten(e).forEach(function(e){var r=0===e.indexOf("!");r&&(e=e.slice(1));var i=t(e);n=r?grunt.util._.difference(n,i):grunt.util._.union(n,i)}),n};file.match=function(e,t,n){return"object"!==grunt.util.kindOf(e)&&(n=t,t=e,e={}),null==t||null==n?[]:(Array.isArray(t)||(t=[t]),Array.isArray(n)||(n=[n]),0===t.length||0===n.length?[]:processPatterns(t,function(t){return file.minimatch.match(n,t,e)}))},file.isMatch=function(){return file.match.apply(file,arguments).length>0},file.expand=function(){var e=grunt.util.toArray(arguments),t="object"===grunt.util.kindOf(e[0])?e.shift():{},n=Array.isArray(e[0])?e[0]:e;if(0===n.length)return[];var r=processPatterns(n,function(e){return file.glob.sync(e,t)});return t.filter&&(r=r.filter(function(e){e=path.join(t.cwd,e);try{return"function"==typeof t.filter?t.filter(e):fs.statSync(e)[t.filter]()}catch(n){return!1}})),r};var pathSeparatorRe=/[\/\\]/g;file.expandMapping=function(e,t,n){n=grunt.util._.defaults({},n,{rename:function(e,t){return path.join(e,t)}});var r=[],i={};return file.expand(n,e).forEach(function(e){var o=e;n.flatten&&(o=path.basename(o)),n.ext&&(o=o.replace(/(\.[^\/]*)?$/,n.ext));var a=n.rename(t,o,n);n.cwd&&(e=path.join(n.cwd,e)),a=a.replace(pathSeparatorRe,"/"),e=e.replace(pathSeparatorRe,"/"),i[a]?i[a].src.push(e):(r.push({src:[e],dest:a}),i[a]=r[r.length-1])}),r},file.mkdir=function(e,t){grunt.option("no-write")||(null==t&&(t=parseInt("0777",8)&~process.umask()),e.split(pathSeparatorRe).reduce(function(e,n){e+=n+"/";var r=path.resolve(e);if(!file.exists(r))try{fs.mkdirSync(r,t)}catch(i){throw grunt.util.error('Unable to create directory "'+r+'" (Error code: '+i.code+").",i)}return e},""))},file.recurse=function recurse(e,t,n){var r=n?path.join(e,n):e;fs.readdirSync(r).forEach(function(i){var o=path.join(r,i);fs.statSync(o).isDirectory()?recurse(e,t,unixifyPath(path.join(n,i))):t(unixifyPath(o),e,n,i)})},file.defaultEncoding="utf8",file.read=function(e,t){t||(t={});var n;grunt.verbose.write("Reading "+e+"...");try{return n=fs.readFileSync(e+""),null!==t.encoding&&(n=iconv.decode(n,t.encoding||file.defaultEncoding),65279===n.charCodeAt(0)&&(n=n.substring(1))),grunt.verbose.ok(),n}catch(r){throw grunt.verbose.error(),grunt.util.error('Unable to read "'+e+'" file (Error code: '+r.code+").",r)}},file.readJSON=function(e,t){var n,r=file.read(e,t);grunt.verbose.write("Parsing "+e+"...");try{return n=JSON.parse(r),grunt.verbose.ok(),n}catch(i){throw grunt.verbose.error(),grunt.util.error('Unable to parse "'+e+'" file ('+i.message+").",i)}},file.readYAML=function(e,t){var n,r=file.read(e,t);grunt.verbose.write("Parsing "+e+"...");try{return n=YAML.load(r),grunt.verbose.ok(),n}catch(i){throw grunt.verbose.error(),grunt.util.error('Unable to parse "'+e+'" file ('+i.problem+").",i)}},file.write=function(e,t,n){n||(n={});var r=grunt.option("no-write");grunt.verbose.write((r?"Not actually writing ":"Writing ")+e+"..."),file.mkdir(path.dirname(e));try{return Buffer.isBuffer(t)||(t=iconv.encode(t,n.encoding||file.defaultEncoding)),r||fs.writeFileSync(e,t),grunt.verbose.ok(),!0}catch(i){throw grunt.verbose.error(),grunt.util.error('Unable to write "'+e+'" file (Error code: '+i.code+").",i)}},file.copy=function(e,t,n){n||(n={});var r=n.process&&n.noProcess!==!0&&!(n.noProcess&&file.isMatch(n.noProcess,e)),i=r?n:{encoding:null},o=file.read(e,i);if(r){grunt.verbose.write("Processing source...");try{o=n.process(o,e),grunt.verbose.ok()}catch(a){throw grunt.verbose.error(),grunt.util.error('Error while processing "'+e+'" file.',a)}}o===!1?grunt.verbose.writeln("Write aborted."):file.write(t,o,i)},file.delete=function(e,t){e+="";var n=grunt.option("no-write");if(t||(t={force:grunt.option("force")||!1}),grunt.verbose.write((n?"Not actually deleting ":"Deleting ")+e+"..."),!t.force){if(file.isPathCwd(e))return grunt.verbose.error(),grunt.fail.warn("Cannot delete the current working directory."),!1;if(!file.isPathInCwd(e))return grunt.verbose.error(),grunt.fail.warn("Cannot delete files outside the current working directory."),!1}try{return n||rimraf.sync(e),grunt.verbose.ok(),!0}catch(r){throw grunt.verbose.error(),grunt.util.error('Unable to delete "'+e+'" file ('+r.message+").",r)}},file.exists=function(){var e=path.join.apply(path,arguments);return fs.existsSync(e)},file.isLink=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.lstatSync(e).isSymbolicLink()},file.isDir=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.statSync(e).isDirectory()},file.isFile=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.statSync(e).isFile()},file.isPathAbsolute=function(){var e=path.join.apply(path,arguments);return path.resolve(e)===e.replace(/[\/\\]+$/,"")},file.arePathsEquivalent=function(e){e=path.resolve(e);for(var t=1;arguments.length>t;t++)if(e!==path.resolve(arguments[t]))return!1;return!0},file.doesPathContain=function(e){e=path.resolve(e);for(var t,n=1;arguments.length>n;n++)if(t=path.relative(path.resolve(arguments[n]),e),""===t||/\w+/.test(t))return!1;return!0},file.isPathCwd=function(){var e=path.join.apply(path,arguments);try{return file.arePathsEquivalent(process.cwd(),fs.realpathSync(e))}catch(t){return!1}},file.isPathInCwd=function(){var e=path.join.apply(path,arguments);try{return file.doesPathContain(process.cwd(),fs.realpathSync(e))}catch(t){return!1}};