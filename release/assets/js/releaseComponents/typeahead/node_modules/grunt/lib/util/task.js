/*
 * grunt
 * http://gruntjs.com/
 *
 * Copyright (c) 2012 "Cowboy" Ben Alman
 * Licensed under the MIT license.
 * https://github.com/gruntjs/grunt/blob/master/LICENSE-MIT
 */

(function(e){function t(){this.current={},this._tasks={},this._queue=[],this._placeholder={placeholder:!0},this._marker={marker:!0},this._options={},this._running=!1,this._success={}}e.Task=t,e.create=function(){return new t},t.prototype._throwIfRunning=function(e){if(this._running||!this._options.error)throw e;this._options.error.call({name:null},e)},t.prototype.registerTask=function(e,t,n){null==n&&(n=t,t=null);var r;return"function"!=typeof n?(r=this.parseArgs([n]),n=this.run.bind(this,n),n.alias=!0,t||(t='Alias for "'+r.join('", "')+'" task'+(1===r.length?"":"s")+".")):t||(t="Custom task."),this._tasks[e]={name:e,info:t,fn:n},this},t.prototype.isTaskAlias=function(e){return!!this._tasks[e].fn.alias},t.prototype.renameTask=function(e,t){return this._tasks[t]=this._tasks[e],this._tasks[t].name=t,delete this._tasks[e],this},t.prototype.parseArgs=function(e){return Array.isArray(e[0])?e[0]:[].slice.call(e)},t.prototype.splitArgs=function(e){return e?(e=e.replace(/\\\\/g,"￿").replace(/\\:/g,"￾"),e.split(":").map(function(e){return e.replace(/\uFFFE/g,":").replace(/\uFFFF/g,"\\")})):[]},t.prototype._taskPlusArgs=function(e){var t,n=this.splitArgs(e),r=n.length;do t=this._tasks[n.slice(0,r).join(":")];while(!t&&--r>0);var i=n.slice(r),o={};return i.forEach(function(e){o[e]=!0}),{task:t,nameArgs:e,args:i,flags:o}},t.prototype._push=function(e){var t=this._queue.indexOf(this._placeholder);-1===t?this._queue=this._queue.concat(e):[].splice.apply(this._queue,[t,0].concat(e))},t.prototype.run=function(){var e=this.parseArgs(arguments).map(this._taskPlusArgs,this),t=e.filter(function(e){return!e.task});return t.length>0?(this._throwIfRunning(Error('Task "'+t[0].nameArgs+'" not found.')),this):(this._push(e),this)},t.prototype.mark=function(){return this._push(this._marker),this},t.prototype.runTaskFn=function(e,t,n){var r=!1,i=function(t){var r=null;t===!1?r=Error('Task "'+e.nameArgs+'" failed.'):t instanceof Error||"[object Error]"==={}.toString.call(t)?(r=t,t=!1):t=!0,this.current={},this._success[e.nameArgs]=t,!t&&this._options.error&&this._options.error.call({name:e.name,nameArgs:e.nameArgs},r),n(r,t)}.bind(this);e.async=function(){return r=!0,function(e){setTimeout(function(){i(e)},1)}},this.current=e;try{var o=t.call(e);r||i(o)}catch(a){i(a)}},t.prototype.start=function(){if(this._running)return!1;var e=function(){var t;do t=this._queue.shift();while(t===this._placeholder||t===this._marker);if(!t)return this._running=!1,this._options.done&&this._options.done(),void 0;this._queue.unshift(this._placeholder);var n={nameArgs:t.nameArgs,name:t.task.name,args:t.args,flags:t.flags};this.runTaskFn(n,function(){return t.task.fn.apply(this,this.args)},e)}.bind(this);this._running=!0,e()},t.prototype.clearQueue=function(e){return e||(e={}),e.untilMarker?this._queue.splice(0,this._queue.indexOf(this._marker)+1):this._queue=[],this},t.prototype.requires=function(){this.parseArgs(arguments).forEach(function(e){var t=this._success[e];if(!t)throw Error('Required task "'+e+'" '+(t===!1?"failed":"must be run first")+".")}.bind(this))},t.prototype.options=function(e){Object.keys(e).forEach(function(t){this._options[t]=e[t]}.bind(this))}})("object"==typeof exports&&exports||this);