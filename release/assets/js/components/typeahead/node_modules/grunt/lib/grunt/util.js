/*
 * grunt
 * http://gruntjs.com/
 *
 * Copyright (c) 2012 "Cowboy" Ben Alman
 * Licensed under the MIT license.
 * https://github.com/gruntjs/grunt/blob/master/LICENSE-MIT
 */

var spawn=require("child_process").spawn,nodeUtil=require("util"),path=require("path"),util=module.exports={};util.task=require("../util/task"),util.namespace=require("../util/namespace"),util.exit=require("../util/exit").exit,util.hooker=require("hooker"),util.async=require("async");var _=util._=require("lodash"),which=require("which").sync;_.str=require("underscore.string"),_.mixin(_.str.exports()),util.callbackify=function(e){return function(){var t=e.apply(this,arguments),n=arguments.length;if(n!==e.length){var r=arguments[n-1];"function"==typeof r&&r(t)}}},util.error=function(e,t){return nodeUtil.isError(e)||(e=Error(e)),t&&(e.origError=t),e},util.linefeed="win32"===process.platform?"\r\n":"\n",util.normalizelf=function(e){return e.replace(/\r\n|\n/g,util.linefeed)};var kindsOf={};"Number String Boolean Function RegExp Array Date Error".split(" ").forEach(function(e){kindsOf["[object "+e+"]"]=e.toLowerCase()}),util.kindOf=function(e){return null==e?e+"":kindsOf[kindsOf.toString.call(e)]||"object"},util.toArray=Function.call.bind(Array.prototype.slice),util.repeat=function(e,t){return Array(e+1).join(t||" ")},util.pluralize=function(e,t,n){var r=t.split(n||"/");return 1===e?r[0]||"":r[1]||""},util.recurse=function recurse(e,t,n){var r;return n&&n(e)===!1?e:"array"===util.kindOf(e)?e.map(function(e){return recurse(e,t,n)}):"object"===util.kindOf(e)?(r={},Object.keys(e).forEach(function(i){r[i]=recurse(e[i],t,n)}),r):t(e)},util.spawn=function(e,t){var n,r,i=function(n,r,i){r=_.rtrim(r),i=_.rtrim(i);var o={stdout:r,stderr:i,code:n,toString:function(){return 0===n?r:"fallback"in e?e.fallback:i}};t(0===n||"fallback"in e?null:Error(i),o,n)},o=/[\\\/]/g;if(e.grunt)n=process.argv[0],r=[process.argv[1]].concat(e.args);else{try{n=o.test(e.cmd)?e.cmd.replace(o,path.sep):which(e.cmd)}catch(a){return i(127,"",a+""),void 0}r=e.args}var s=spawn(n,r,e.opts),u="",c="";return s.stdout&&s.stdout.on("data",function(e){u+=e}),s.stderr&&s.stderr.on("data",function(e){c+=e}),s.on("close",function(e){i(e,u,c)}),s};