function DirReader(e){var t=this;if(!(t instanceof DirReader))throw Error("DirReader must be called as constructor.");if("Directory"!==e.type||!e.Directory)throw Error("Non-directory type "+e.type);t.entries=null,t._index=-1,t._paused=!1,t._length=-1,e.sort&&(this.sort=e.sort),Reader.call(this,e)}module.exports=DirReader;var fs=require("../../graceful-fs/graceful-fs.js"),fstream=require("../fstream.js"),Reader=fstream.Reader,inherits=require("../../inherits/inherits.js"),mkdir=require("../../mkdirp"),path=require("path"),Reader=require("./reader.js"),assert=require("assert").ok;inherits(DirReader,Reader),DirReader.prototype._getEntries=function(){var e=this;e._gotEntries||(e._gotEntries=!0,fs.readdir(e._path,function(t,n){function r(){e._length=e.entries.length,"function"==typeof e.sort&&(e.entries=e.entries.sort(e.sort.bind(e))),e._read()}return t?e.error(t):(e.entries=n,e.emit("entries",n),e._paused?e.once("resume",r):r(),void 0)}))},DirReader.prototype._read=function(){var e=this;if(!e.entries)return e._getEntries();if(!(e._paused||e._currentEntry||e._aborted)){if(e._index++,e._index>=e.entries.length)return e._ended||(e._ended=!0,e.emit("end"),e.emit("close")),void 0;var t=path.resolve(e._path,e.entries[e._index]);assert(t!==e._path),assert(e.entries[e._index]),e._currentEntry=t,fs[e.props.follow?"stat":"lstat"](t,function(n,r){function i(){l||(l=!0,e.emit("childEnd",s),e.emit("entryEnd",s),e._currentEntry=null,e._paused||e._read())}if(n)return e.error(n);var o=e._proxy||e;r.path=t,r.basename=path.basename(t),r.dirname=path.dirname(t);var a=e.getChildProps.call(o,r);a.path=t,a.basename=path.basename(t),a.dirname=path.dirname(t);var s=Reader(a,r);e._currentEntry=s,s.on("pause",function(t){e._paused||s._disowned||e.pause(t)}),s.on("resume",function(t){e._paused&&!s._disowned&&e.resume(t)}),s.on("stat",function(t){e.emit("_entryStat",s,t),s._aborted||(s._paused?s.once("resume",function(){e.emit("entryStat",s,t)}):e.emit("entryStat",s,t))}),s.on("ready",function u(){return e._paused?(s.pause(e),e.once("resume",u)):("Socket"===s.type?e.emit("socket",s):e.emitEntry(s),void 0)});var l=!1;s.on("close",i),s.on("disown",i),s.on("error",function(t){s._swallowErrors?(e.warn(t),s.emit("end"),s.emit("close")):e.emit("error",t)}),["child","childEnd","warn"].forEach(function(t){s.on(t,e.emit.bind(e,t))})})}},DirReader.prototype.disown=function(e){e.emit("beforeDisown"),e._disowned=!0,e.parent=e.root=null,e===this._currentEntry&&(this._currentEntry=null),e.emit("disown")},DirReader.prototype.getChildProps=function(){return{depth:this.depth+1,root:this.root||this,parent:this,follow:this.follow,filter:this.filter,sort:this.props.sort}},DirReader.prototype.pause=function(e){var t=this;t._paused||(e=e||t,t._paused=!0,t._currentEntry&&t._currentEntry.pause&&t._currentEntry.pause(e),t.emit("pause",e))},DirReader.prototype.resume=function(e){var t=this;t._paused&&(e=e||t,t._paused=!1,t.emit("resume",e),t._paused||(t._currentEntry?t._currentEntry.resume&&t._currentEntry.resume(e):t._read()))},DirReader.prototype.emitEntry=function(e){this.emit("entry",e),this.emit("child",e)};