function Pack(e){var t=this;return t instanceof Pack?(t._noProprietary=e?e.noProprietary:!1,t._global=e,t.readable=!0,t.writable=!0,t._buffer=[],t._currentEntry=null,t._processing=!1,t._pipeRoot=null,t.on("pipe",function(e){e.root!==t._pipeRoot&&(t._pipeRoot=e,e.on("end",function(){t._pipeRoot=null}),t.add(e))}),void 0):new Pack(e)}module.exports=Pack;for(var EntryWriter=require("./entry-writer.js"),Stream=require("stream").Stream,path=require("path"),inherits=require("../vendor/inherits/inherits.js"),GlobalHeaderWriter=require("./global-header-writer.js"),collect=require("../vendor/fstream/fstream.js").collect,eof=new Buffer(512),i=0;512>i;i++)eof[i]=0;inherits(Pack,Stream),Pack.prototype.addGlobal=function(e){if(!this._didGlobal){this._didGlobal=!0;var t=this;GlobalHeaderWriter(e).on("data",function(e){t.emit("data",e)}).end()}},Pack.prototype.add=function(e){return this._global&&!this._didGlobal&&this.addGlobal(this._global),this._ended?this.emit("error",Error("add after end")):(collect(e),this._buffer.push(e),this._process(),this._needDrain=this._buffer.length>0,!this._needDrain)},Pack.prototype.pause=function(){this._paused=!0,this._currentEntry&&this._currentEntry.pause(),this.emit("pause")},Pack.prototype.resume=function(){this._paused=!1,this._currentEntry&&this._currentEntry.resume(),this.emit("resume"),this._process()},Pack.prototype.end=function(){this._ended=!0,this._buffer.push(eof),this._process()},Pack.prototype._process=function(){function e(){s||(s=!0,t._currentEntry=null,t._processing=!1,t._process())}var t=this;if(!t._paused&&!t._processing){var n=t._buffer.shift();if(!n)return t._needDrain&&t.emit("drain"),void 0;if(n.ready===!1)return t._buffer.unshift(n),n.on("ready",function(){t._process()}),void 0;if(t._processing=!0,n===eof)return t.emit("data",eof),t.emit("data",eof),t.emit("end"),t.emit("close"),void 0;var r=path.dirname((n.root||n).path),i={};switch(Object.keys(n.props).forEach(function(e){i[e]=n.props[e]}),t._noProprietary&&(i.noProprietary=!0),i.path=path.relative(r,n.path),"win32"===process.platform&&(i.path=i.path.replace(/\\/g,"/")),i.type){case"Socket":return;case"Directory":i.path+="/",i.size=0;break;case"Link":var o=path.resolve(path.dirname(n.path),n.linkpath);i.linkpath=path.relative(r,o)||".",i.size=0;break;case"SymbolicLink":var o=path.resolve(path.dirname(n.path),n.linkpath);i.linkpath=path.relative(path.dirname(n.path),o)||".",i.size=0}var a=t._currentEntry=EntryWriter(i);a.parent=t,a.on("data",function(e){t.emit("data",e)}),a.on("header",function(){Buffer.prototype.toJSON=function(){return(""+this).split(/\0/).join(".")},0===a.props.size&&e()}),a.on("close",e);var s=!1;a.on("error",function(e){t.emit("error",e)}),n===t._pipeRoot&&(a.add=null),n.pipe(a)}},Pack.prototype.destroy=function(){},Pack.prototype.write=function(){};