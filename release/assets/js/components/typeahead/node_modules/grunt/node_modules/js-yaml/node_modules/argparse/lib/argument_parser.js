var util=require("util"),Path=require("path"),_=require("underscore");_.str=require("underscore.string");var $$=require("./const"),ActionContainer=require("./action_container"),argumentErrorHelper=require("./argument/error"),HelpFormatter=require("./help/formatter"),Namespace=require("./namespace"),ArgumentParser=module.exports=function ArgumentParser(e){var t=this;e=e||{},e.description=e.description||null,e.argumentDefault=e.argumentDefault||null,e.prefixChars=e.prefixChars||"-",e.conflictHandler=e.conflictHandler||"error",ActionContainer.call(this,e),e.addHelp=void 0===e.addHelp||!!e.addHelp,e.parents=e.parents||[],e.prog=e.prog||Path.basename(process.argv[1]),this.prog=e.prog,this.usage=e.usage,this.epilog=e.epilog,this.version=e.version,this.debug=e.debug===!0,this.formatterClass=e.formatterClass||HelpFormatter,this.fromfilePrefixChars=e.fromfilePrefixChars||null,this._positionals=this.addArgumentGroup({title:"Positional arguments"}),this._optionals=this.addArgumentGroup({title:"Optional arguments"}),this._subparsers=null;var n=function(e){return e};this.register("type","auto",n),this.register("type",null,n),this.register("type","int",function(e){var t=parseInt(e,10);if(isNaN(t))throw Error(e+" is not a valid integer.");return t}),this.register("type","float",function(e){var t=parseFloat(e);if(isNaN(t))throw Error(e+" is not a valid float.");return t}),this.register("type","string",function(e){return""+e});var r=this.prefixChars.indexOf("-")>-1?"-":this.prefixChars[0];e.addHelp&&this.addArgument([r+"h",r+r+"help"],{action:"help",defaultValue:$$.SUPPRESS,help:"Show this help message and exit."}),void 0!==this.version&&this.addArgument([r+"v",r+r+"version"],{action:"version",version:this.version,defaultValue:$$.SUPPRESS,help:"Show program's version number and exit."}),e.parents.forEach(function(e){if(t._addContainerActions(e),void 0!==e._defaults)for(var n in e._defaults)e._defaults.hasOwnProperty(n)&&(t._defaults[n]=e._defaults[n])})};util.inherits(ArgumentParser,ActionContainer),ArgumentParser.prototype.addSubparsers=function(e){if(this._subparsers&&this.error("Cannot have multiple subparser arguments."),e=e||{},e.debug=this.debug===!0,e.optionStrings=[],e.parserClass=e.parserClass||ArgumentParser,e.title||e.description?(this._subparsers=this.addArgumentGroup({title:e.title||"subcommands",description:e.description}),delete e.title,delete e.description):this._subparsers=this._positionals,!e.prog){var t=this._getFormatter(),n=this._getPositionalActions(),r=this._mutuallyExclusiveGroups;t.addUsage(this.usage,n,r,""),e.prog=_.str.strip(t.formatHelp())}var i=this._popActionClass(e,"parsers"),o=new i(e);return this._subparsers._addAction(o),o},ArgumentParser.prototype._addAction=function(e){return e.isOptional()?this._optionals._addAction(e):this._positionals._addAction(e),e},ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(e){return e.isOptional()})},ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(e){return e.isPositional()})},ArgumentParser.prototype.parseArgs=function(e,t){var n,r=this.parseKnownArgs(e,t);return e=r[0],n=r[1],n&&n.length>0&&this.error(_.str.sprintf("Unrecognized arguments: %(args)s.",{args:n.join(" ")})),e},ArgumentParser.prototype.parseKnownArgs=function(e,t){var n=this;e=e||process.argv.slice(2),t=t||new Namespace,n._actions.forEach(function(e){if(e.dest!==$$.SUPPRESS&&!_.has(t,e.dest)&&e.defaultValue!==$$.SUPPRESS){var r=e.defaultValue;_.isString(e.defaultValue)&&(r=n._getValue(e,r)),t[e.dest]=r}}),_.keys(n._defaults).forEach(function(e){t[e]=n._defaults[e]});try{var r=this._parseKnownArgs(e,t);return t=r[0],e=r[1],_.has(t,$$._UNRECOGNIZED_ARGS_ATTR)&&(e=_.union(e,t[$$._UNRECOGNIZED_ARGS_ATTR]),delete t[$$._UNRECOGNIZED_ARGS_ATTR]),[t,e]}catch(i){this.error(i)}},ArgumentParser.prototype._parseKnownArgs=function(e,t){function n(e){return e.getName()}function r(e,r,i){g.push(e);var o=a._getValues(e,r);o!==e.defaultValue&&(m.push(e),l[n(e)]&&l[n(e)].forEach(function(t){if(m.indexOf(t)>=0)throw argumentErrorHelper(e,_.str.sprintf('Not allowed with argument "%(argument)s".',{argument:t.getName()}))})),o!==$$.SUPPRESS&&e.call(a,t,o,i)}function i(t){for(var n,i,o,u,c=p[t],l=c[0],f=c[1],h=c[2],g=[];;){if(!l)return s.push(e[t]),t+1;if(!h){o=t+1;var m=d.substr(o);i=a._matchArgument(l,m),u=o+i,n=e.slice(o,u),g.push([l,n,f]);break}i=a._matchArgument(l,"A");var v=a.prefixChars;if(!(0===i&&0>v.indexOf(f[1]))){if(1===i){u=t+1,n=[h],g.push([l,n,f]);break}var y="ignored explicit argument %r";throw argumentErrorHelper(l,_.str.sprintf(y,h))}g.push([l,[],f]),f=f[0]+h[0];var b=h.slice(1)||null,k=a._optionStringActions;if(!(_.keys(k).indexOf(f)>=0)){var w="ignored explicit argument %r";throw argumentErrorHelper(l,w)}l=k[f],h=b}if(1>g.length)throw Error("length should be > 0");for(var x=0;g.length>x;x++)r.apply(a,g[x]);return u}function o(t){var n=d.substr(t),i=a._matchArgumentsPartial(v,n);return _.zip(v,i).forEach(function(n){var i=n[0],o=n[1];if(void 0!==o){var a=e.slice(t,t+o);t+=o,r(i,a)}}),v=v.slice(i.length),t}var a=this,s=[];null!==this.fromfilePrefixChars&&(e=this._readArgsFromFiles(e));var u,c,l={};this._mutuallyExclusiveGroups.forEach(function(e){e._groupActions.forEach(function(e,t,r){c=n(e),_.has(l,c)||(l[c]=[]),u=l[c],u.push.apply(u,r.slice(0,t)),u.push.apply(u,r.slice(t+1))})});var p={},f=[];e.forEach(function(t,n){if("--"===t)for(f.push("-");e.length>n;)f.push("A"),n++;else{var r,i=a._parseOptional(t);i?(p[n]=i,r="O"):r="A",f.push(r)}});var h,d=f.join(""),g=[],m=[],v=a._getPositionalActions(),y=0,b=-1;if(p)for(h in p)b=Math.max(b,parseInt(h,10));for(var k,w;b>=y;){w=null;for(h in p)h=parseInt(h,10),h>=y&&(w=null!==w?Math.min(w,h):h);if(y!==w){if(k=o(y),k>y){y=k;continue}y=k}if(!p[y]){var x=e.slice(y,w);s=s.concat(x),y=w}y=i(y)}var E=o(y);s=s.concat(_.rest(e,E)),v.length>0&&a.error("too few arguments"),a._actions.forEach(function(e){e.required&&0>_.indexOf(g,e)&&a.error(_.str.sprintf('Argument "%(name)s" is required',{name:e.getName()}))});var S=!1;return a._mutuallyExclusiveGroups.forEach(function(e){if(e.required&&(S=_.any(e._groupActions,function(e){return _.contains(m,e)}),!S)){var t=[];e._groupActions.forEach(function(e){e.help!==$$.SUPPRESS&&t.push(e.getName())}),t=t.join(" ");var n="one of the arguments "+t+" is required";a.error(n)}}),[t,s]},ArgumentParser.prototype._readArgsFromFiles=function(e){var t=this,n=require("fs"),r=[];return e.forEach(function(e){if(0>t.fromfilePrefixChars.indexOf(e[0]))r.push(e);else try{var i=[],o=e.slice(1),a=n.readFileSync(o,"utf8");a=a.trim().split("\n"),a.forEach(function(e){t.convertArgLineToArgs(e).forEach(function(e){i.push(e)}),i=t._readArgsFromFiles(i)}),r.push.apply(r,i)}catch(s){return t.error(s.message)}}),r},ArgumentParser.prototype.convertArgLineToArgs=function(e){return[e]},ArgumentParser.prototype._matchArgument=function(e,t){var n,r=RegExp("^"+this._getNargsPattern(e)),i=t.match(r);if(!i){switch(e.nargs){case void 0:case null:n="Expected one argument.";break;case $$.OPTIONAL:n="Expected at most one argument.";break;case $$.ONE_OR_MORE:n="Expected at least one argument.";break;default:n="Expected %(count)s argument(s)"}throw argumentErrorHelper(e,_.str.sprintf(n,{count:e.nargs}))}return i[1].length},ArgumentParser.prototype._matchArgumentsPartial=function(e,t){var n,r,i,o,a,s=this,u=[],c=function(e){return e.length};for(o=e.length;o>0;o-=1){r="",n=e.slice(0,o);for(a in n)r+=s._getNargsPattern(n[a]);if(r=RegExp("^"+r),i=t.match(r),i&&i.length>0){i=i.splice(1),u=u.concat(i.map(c));break}}return u},ArgumentParser.prototype._parseOptional=function(e){var t,n,r,i;if(!e)return null;if(0>this.prefixChars.indexOf(e[0]))return null;if(this._optionStringActions[e])return[this._optionStringActions[e],e,null];if(1===e.length)return null;if(e.indexOf("=")>=0){var o=e.split("=");if(n=o[0],r=o[1],this._optionStringActions[n])return t=this._optionStringActions[n],[t,n,r]}if(i=this._getOptionTuples(e),i.length>1){var a=i.map(function(e){return e[1]});this.error(_.str.sprintf('Ambiguous option: "%(argument)s" could match %(values)s.',{argument:e,values:a.join(", ")}))}else if(1===i.length)return i[0];return e.match(this._regexpNegativeNumber)&&!_.any(this._hasNegativeNumberOptionals)?null:e.search(" ")>=0?null:[null,e,null]},ArgumentParser.prototype._getOptionTuples=function(e){var t,n,r,i,o=[],a=this.prefixChars;if(a.indexOf(e[0])>=0&&a.indexOf(e[1])>=0){if(e.indexOf("=")>=0){var s=e.split("=",1);t=s[0],n=s[1]}else t=e,n=null;for(i in this._optionStringActions)i.substr(0,t.length)===t&&(r=this._optionStringActions[i],o.push([r,i,n]))}else{if(!(a.indexOf(e[0])>=0&&0>a.indexOf(e[1])))throw Error(_.str.sprintf("Unexpected option string: %(argument)s.",{argument:e}));t=e,n=null;var u=e.substr(0,2),c=e.substr(2);for(i in this._optionStringActions)r=this._optionStringActions[i],i===u?o.push([r,i,c]):i.substr(0,t.length)===t&&o.push([r,i,n])}return o},ArgumentParser.prototype._getNargsPattern=function(e){var t;switch(e.nargs){case void 0:case null:t="(-*A-*)";break;case $$.OPTIONAL:t="(-*A?-*)";break;case $$.ZERO_OR_MORE:t="(-*[A-]*)";break;case $$.ONE_OR_MORE:t="(-*A[A-]*)";break;case $$.REMAINDER:t="([-AO]*)";break;case $$.PARSER:t="(-*A[-AO]*)";break;default:t="(-*"+_.str.repeat("-*A",e.nargs)+"-*)"}return e.isOptional()&&(t=t.replace(/-\*/g,""),t=t.replace(/-/g,"")),t},ArgumentParser.prototype._getValues=function(e,t){var n=this;e.nargs!==$$.PARSER&&e.nargs!==$$.REMAINDER&&(t=t.filter(function(e){return"--"!==e}));var r,i;return 0===t.length&&e.nargs===$$.OPTIONAL?(r=e.isOptional()?e.constant:e.defaultValue,"string"==typeof r&&(r=this._getValue(e,r),this._checkValue(e,r))):0===t.length&&e.nargs===$$.ZERO_OR_MORE&&0===e.optionStrings.length?(r=e.defaultValue||t,this._checkValue(e,r)):1!==t.length||e.nargs&&e.nargs!==$$.OPTIONAL?e.nargs===$$.REMAINDER?r=t.map(function(t){return n._getValue(e,t)}):e.nargs===$$.PARSER?(r=t.map(function(t){return n._getValue(e,t)}),this._checkValue(e,r[0])):(r=t.map(function(t){return n._getValue(e,t)}),r.forEach(function(t){n._checkValue(e,t)})):(i=t[0],r=this._getValue(e,i),this._checkValue(e,r)),r},ArgumentParser.prototype._getValue=function(e,t){var n,r=this._registryGet("type",e.type,e.type);if(!_.isFunction(r)){var i=_.str.sprintf("%(callback)s is not callable",{callback:r});throw argumentErrorHelper(e,i)}try{n=r(t)}catch(o){var a=null;a=_.isString(e.type)?e.type:e.type.name||e.type.displayName||"<function>";var s=_.str.sprintf("Invalid %(type)s value: %(value)s",{type:a,value:t});throw"<function>"===a&&(s+="\n"+o.message),argumentErrorHelper(e,s)}return n},ArgumentParser.prototype._checkValue=function(e,t){var n=e.choices;if(n){if((_.isString(n)||_.isArray(n))&&-1!==n.indexOf(t))return;if(_.isObject(n)&&!_.isArray(n)&&n[t])return;n=_.isString(n)?n.split("").join(", "):_.isArray(n)?n.join(", "):_.keys(n).join(", ");var r=_.str.sprintf("Invalid choice: %(value)s (choose from [%(choices)s])",{value:t,choices:n});throw argumentErrorHelper(e,r)}},ArgumentParser.prototype.formatUsage=function(){var e=this._getFormatter();return e.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),e.formatHelp()},ArgumentParser.prototype.formatHelp=function(){var e=this._getFormatter();return e.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),e.addText(this.description),this._actionGroups.forEach(function(t){e.startSection(t.title),e.addText(t.description),e.addArguments(t._groupActions),e.endSection()}),e.addText(this.epilog),e.formatHelp()},ArgumentParser.prototype._getFormatter=function(){var e=this.formatterClass,t=new e({prog:this.prog});return t},ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())},ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())},ArgumentParser.prototype._printMessage=function(e,t){t||(t=process.stdout),e&&t.write(""+e)},ArgumentParser.prototype.exit=function(e,t){t&&(0===e?this._printMessage(t):this._printMessage(t,process.stderr)),process.exit(e)},ArgumentParser.prototype.error=function(e){var t;if(e instanceof Error){if(this.debug===!0)throw e;t=e.message}else t=e;var n=_.str.sprintf("%(prog)s: error: %(err)s",{prog:this.prog,err:t})+$$.EOL;if(this.debug===!0)throw Error(n);return this.printUsage(process.stderr),this.exit(2,n)};