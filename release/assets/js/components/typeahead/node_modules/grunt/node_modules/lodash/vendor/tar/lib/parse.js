function Parse(){var e=this;return e instanceof Parse?(Stream.apply(e),e.writable=!0,e.readable=!0,e._stream=new BlockStream(512),e.position=0,e._stream.on("error",function(t){e.emit("error",t)}),e._stream.on("data",function(t){e._process(t)}),e._stream.on("end",function(){e._streamEnd()}),e._stream.on("drain",function(){e.emit("drain")}),void 0):new Parse}module.exports=Parse.create=Parse;var stream=require("stream"),Stream=stream.Stream,BlockStream=require("../vendor/block-stream/block-stream.js"),tar=require("../tar.js"),TarHeader=require("./header.js"),Entry=require("./entry.js"),BufferEntry=require("./buffer-entry.js"),ExtendedHeader=require("./extended-header.js"),assert=require("assert").ok,inherits=require("../vendor/inherits/inherits.js"),fstream=require("../vendor/fstream/fstream.js");inherits(Parse,fstream.Reader),Parse.prototype._streamEnd=function(){var e=this;e._ended||e.error("unexpected eof"),e.emit("end")},Parse.prototype.write=function(e){if(!this._ended)return this._stream.write(e);for(var t=0,n=e.length;t>n;t++)if(0!==e[t])return this.error("write() after end()")},Parse.prototype.end=function(e){return this._ended=!0,this._stream.end(e)},Parse.prototype._read=function(){},Parse.prototype._process=function(e){if(assert(e&&512===e.length,"block size should be 512"),this._entry){var t=this._entry;t.write(e),0===t._remaining&&(t.end(),this._entry=null)}else{for(var n=!0,r=0;512>r&&n;r++)n=0===e[r];n?(this._ended=this._eofStarted,this._eofStarted=!0):(this._ended=this._eofStarted=!1,this._startEntry(e))}this.position+=512},Parse.prototype._startEntry=function(e){var t,n,r,i,o=new TarHeader(e),a=this,s=!1;if(null===o.size||!o.cksumValid){var u=Error("invalid tar file");u.header=o,u.tar_file_offset=this.position,u.tar_block=this.position/512,this.emit("error",u)}switch(tar.types[o.type]){case"File":case"OldFile":case"Link":case"SymbolicLink":case"CharacterDevice":case"BlockDevice":case"Directory":case"FIFO":case"ContiguousFile":case"GNUDumpDir":r=Entry,n="entry";break;case"GlobalExtendedHeader":r=ExtendedHeader,i=function(){a._global=a._global||{},Object.keys(t.fields).forEach(function(e){a._global[e]=t.fields[e]})},n="globalExtendedHeader",s=!0;break;case"ExtendedHeader":case"OldExtendedHeader":r=ExtendedHeader,i=function(){a._extended=t.fields},n="extendedHeader",s=!0;break;case"NextFileHasLongLinkpath":r=BufferEntry,i=function(){a._extended=a._extended||{},a._extended.linkpath=t.body},n="longLinkpath",s=!0;break;case"NextFileHasLongPath":case"OldGnuLongPath":r=BufferEntry,i=function(){a._extended=a._extended||{},a._extended.path=t.body},n="longPath",s=!0;break;default:r=Entry,n="ignoredEntry"}var l,c;if(s)l=c=null;else{var l=this._global,c=this._extended;this._extended=null}t=new r(o,c,l),t.meta=s,s||t.on("data",function(e){f.emit("data",e)}),i&&t.on("end",i),this._entry=t;var f=this;t.on("pause",function(){f.pause()}),t.on("resume",function(){f.resume()}),this.listeners("*").length&&this.emit("*",n,t),this.emit(n,t),0===t.props.size&&(t.end(),this._entry=null)};