function BlockStream(e,t){if(this.writable=this.readable=!0,this._opt=t||{},this._chunkSize=e||512,this._offset=0,this._buffer=[],this._bufferLength=0,this._opt.nopad)this._zeroes=!1;else{this._zeroes=new Buffer(this._chunkSize);for(var n=0;this._chunkSize>n;n++)this._zeroes[n]=0}}module.exports=BlockStream;var Stream=require("stream").Stream,inherits=require("../inherits/inherits.js"),assert=require("assert").ok,debug=process.env.DEBUG?console.error:function(){};inherits(BlockStream,Stream),BlockStream.prototype.write=function(e){if(this._ended)throw Error("BlockStream: write after end");if(e&&!Buffer.isBuffer(e)&&(e=new Buffer(e+"")),e.length&&(this._buffer.push(e),this._bufferLength+=e.length),this._bufferLength>=this._chunkSize){if(this._paused)return this._needDrain=!0,!1;this._emitChunk()}return!0},BlockStream.prototype.pause=function(){this._paused=!0},BlockStream.prototype.resume=function(){return this._paused=!1,this._emitChunk()},BlockStream.prototype.end=function(e){"function"==typeof e&&(cb=e,e=null),e&&this.write(e),this._ended=!0,this.flush()},BlockStream.prototype.flush=function(){this._emitChunk(!0)},BlockStream.prototype._emitChunk=function(e){if(e&&this._zeroes){var t=this._bufferLength%this._chunkSize;0!==t&&(t=this._chunkSize-t),t>0&&(this._buffer.push(this._zeroes.slice(0,t)),this._bufferLength+=t)}if(!this._emitting&&!this._paused){this._emitting=!0;for(var n=0;this._bufferLength>=this._chunkSize&&(e||!this._paused);){for(var r,i=0,o=this._chunkSize;o>0&&(e||!this._paused);){var a=this._buffer[n],s=a.length-this._offset;r||o>s?(r=r||new Buffer(this._chunkSize),a.copy(r,i,this._offset,this._offset+Math.min(s,o))):r=a.length===o&&0===this._offset?a:a.slice(this._offset,this._offset+o),s>o?(this._offset+=o,o=0):(o-=s,i+=s,n++,this._offset=0)}this._bufferLength-=this._chunkSize,assert(r.length===this._chunkSize),this.emit("data",r),r=null}if(this._buffer=this._buffer.slice(n),this._paused)return this._needsDrain=!0,this._emitting=!1,void 0;var u=this._buffer.length;if(e&&!this._zeroes&&u){if(1===u)this._offset?this.emit("data",this._buffer[0].slice(this._offset)):this.emit("data",this._buffer[0]);else{for(var o=this._bufferLength,r=new Buffer(o),i=0,l=0;u>l;l++){var a=this._buffer[l],s=a.length-this._offset;a.copy(r,i,this._offset),this._offset=0,i+=s,this._bufferLength-=s}this.emit("data",r)}this._buffer.length=0,this._bufferLength=0,this._offset=0}this._needDrain&&(this._needDrain=!1,this.emit("drain")),0===this._bufferLength&&this._ended&&!this._endEmitted&&(this._endEmitted=!0,this.emit("end")),this._emitting=!1}};