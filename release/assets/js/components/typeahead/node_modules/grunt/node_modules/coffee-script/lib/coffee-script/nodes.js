(function(){var e,t,n,r,i,o,a,s,u,l,c,f,p,d,h,m,g,v,y,b,w,_,x,k,E,q,S,A,T,j,C,N,O,M,L,$,I,D,F,R,B,P,H,z,U,W,V,G,X,J,K,Y,Q,Z,et,tt,nt,rt,it,ot,at,st,ut,lt={}.hasOwnProperty,ct=function(e,t){function n(){this.constructor=e}for(var r in t)lt.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},ft=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};F=require("./scope").Scope,st=require("./lexer"),M=st.RESERVED,D=st.STRICT_PROSCRIBED,ut=require("./helpers"),K=ut.compact,et=ut.flatten,Z=ut.extend,nt=ut.merge,Y=ut.del,it=ut.starts,Q=ut.ends,tt=ut.last,exports.extend=Z,J=function(){return!0},T=function(){return!1},z=function(){return this},A=function(){return this.negated=!this.negated,this},exports.Base=r=function(){function e(){}return e.prototype.compile=function(e,t){var n;return e=Z({},e),t&&(e.level=t),n=this.unfoldSoak(e)||this,n.tab=e.indent,e.level!==E&&n.isStatement(e)?n.compileClosure(e):n.compileNode(e)},e.prototype.compileClosure=function(e){if(this.jumps())throw SyntaxError("cannot use a pure statement in an expression.");return e.sharedScope=!0,s.wrap(this).compileNode(e)},e.prototype.cache=function(e,t,r){var i,o;return this.isComplex()?(i=new q(r||e.scope.freeVariable("ref")),o=new n(i,this),t?[o.compile(e,t),i.value]:[o,i]):(i=t?this.compile(e,t):this,[i,i])},e.prototype.compileLoopReference=function(e,t){var n,r;return n=r=this.compile(e,_),+n>-1/0&&1/0>+n||d.test(n)&&e.scope.check(n,!0)||(n=""+(r=e.scope.freeVariable(t))+" = "+n),[n,r]},e.prototype.makeReturn=function(e){var t;return t=this.unwrapAll(),e?new o(new q(""+e+".push"),[t]):new $(t)},e.prototype.contains=function(e){var t;return t=!1,this.traverseChildren(!1,function(n){return e(n)?(t=!0,!1):void 0}),t},e.prototype.containsType=function(e){return this instanceof e||this.contains(function(t){return t instanceof e})},e.prototype.lastNonComment=function(e){var t;for(t=e.length;t--;)if(!(e[t]instanceof l))return e[t];return null},e.prototype.toString=function(e,t){var n;return null==e&&(e=""),null==t&&(t=this.constructor.name),n="\n"+e+t,this.soak&&(n+="?"),this.eachChild(function(t){return n+=t.toString(e+H)}),n},e.prototype.eachChild=function(e){var t,n,r,i,o,a,s,u;if(!this.children)return this;for(s=this.children,r=0,o=s.length;o>r;r++)if(t=s[r],this[t])for(u=et([this[t]]),i=0,a=u.length;a>i;i++)if(n=u[i],e(n)===!1)return this;return this},e.prototype.traverseChildren=function(e,t){return this.eachChild(function(n){return t(n)===!1?!1:n.traverseChildren(e,t)})},e.prototype.invert=function(){return new C("!",this)},e.prototype.unwrapAll=function(){var e;for(e=this;e!==(e=e.unwrap()););return e},e.prototype.children=[],e.prototype.isStatement=T,e.prototype.jumps=T,e.prototype.isComplex=J,e.prototype.isChainable=T,e.prototype.isAssignable=T,e.prototype.unwrap=z,e.prototype.unfoldSoak=T,e.prototype.assigns=T,e}(),exports.Block=i=function(e){function t(e){this.expressions=K(et(e||[]))}return ct(t,e),t.prototype.children=["expressions"],t.prototype.push=function(e){return this.expressions.push(e),this},t.prototype.pop=function(){return this.expressions.pop()},t.prototype.unshift=function(e){return this.expressions.unshift(e),this},t.prototype.unwrap=function(){return 1===this.expressions.length?this.expressions[0]:this},t.prototype.isEmpty=function(){return!this.expressions.length},t.prototype.isStatement=function(e){var t,n,r,i;for(i=this.expressions,n=0,r=i.length;r>n;n++)if(t=i[n],t.isStatement(e))return!0;return!1},t.prototype.jumps=function(e){var t,n,r,i;for(i=this.expressions,n=0,r=i.length;r>n;n++)if(t=i[n],t.jumps(e))return t},t.prototype.makeReturn=function(e){var t,n;for(n=this.expressions.length;n--;)if(t=this.expressions[n],!(t instanceof l)){this.expressions[n]=t.makeReturn(e),t instanceof $&&!t.expression&&this.expressions.splice(n,1);break}return this},t.prototype.compile=function(e,n){return null==e&&(e={}),e.scope?t.__super__.compile.call(this,e,n):this.compileRoot(e)},t.prototype.compileNode=function(e){var n,r,i,o,a,s,u;for(this.tab=e.indent,o=e.level===E,r=[],u=this.expressions,a=0,s=u.length;s>a;a++)i=u[a],i=i.unwrapAll(),i=i.unfoldSoak(e)||i,i instanceof t?r.push(i.compileNode(e)):o?(i.front=!0,n=i.compile(e),i.isStatement(e)||(n=""+this.tab+n+";",i instanceof q&&(n=""+n+"\n")),r.push(n)):r.push(i.compile(e,_));return o?this.spaced?"\n"+r.join("\n\n")+"\n":r.join("\n"):(n=r.join(", ")||"void 0",r.length>1&&e.level>=_?"("+n+")":n)},t.prototype.compileRoot=function(e){var t,n,r,i,o,a;return e.indent=e.bare?"":H,e.scope=new F(null,this,null),e.level=E,this.spaced=!0,i="",e.bare||(o=function(){var e,t,i,o;for(i=this.expressions,o=[],r=e=0,t=i.length;t>e&&(n=i[r],n.unwrap()instanceof l);r=++e)o.push(n);return o}.call(this),a=this.expressions.slice(o.length),this.expressions=o,o.length&&(i=""+this.compileNode(nt(e,{indent:""}))+"\n"),this.expressions=a),t=this.compileWithDeclarations(e),e.bare?t:""+i+"(function() {\n"+t+"\n}).call(this);\n"},t.prototype.compileWithDeclarations=function(e){var t,n,r,i,o,a,s,u,c,f,p,d,h,m;for(n=a="",d=this.expressions,o=f=0,p=d.length;p>f&&(i=d[o],i=i.unwrap(),i instanceof l||i instanceof q);o=++f);return e=nt(e,{level:E}),o&&(s=this.expressions.splice(o,9e9),h=[this.spaced,!1],c=h[0],this.spaced=h[1],m=[this.compileNode(e),c],n=m[0],this.spaced=m[1],this.expressions=s),a=this.compileNode(e),u=e.scope,u.expressions===this&&(r=e.scope.hasDeclarations(),t=u.hasAssignments,(r||t)&&(o&&(n+="\n"),n+=""+this.tab+"var ",r&&(n+=u.declaredVariables().join(", ")),t&&(r&&(n+=",\n"+(this.tab+H)),n+=u.assignedVariables().join(",\n"+(this.tab+H))),n+=";\n")),n+a},t.wrap=function(e){return 1===e.length&&e[0]instanceof t?e[0]:new t(e)},t}(r),exports.Literal=q=function(e){function t(e){this.value=e}return ct(t,e),t.prototype.makeReturn=function(){return this.isStatement()?this:t.__super__.makeReturn.apply(this,arguments)},t.prototype.isAssignable=function(){return d.test(this.value)},t.prototype.isStatement=function(){var e;return"break"===(e=this.value)||"continue"===e||"debugger"===e},t.prototype.isComplex=T,t.prototype.assigns=function(e){return e===this.value},t.prototype.jumps=function(e){return"break"!==this.value||(null!=e?e.loop:void 0)||(null!=e?e.block:void 0)?"continue"!==this.value||(null!=e?e.loop:void 0)?void 0:this:this},t.prototype.compileNode=function(e){var t,n;return t="this"===this.value?(null!=(n=e.scope.method)?n.bound:void 0)?e.scope.method.context:this.value:this.value.reserved?'"'+this.value+'"':this.value,this.isStatement()?""+this.tab+t+";":t},t.prototype.toString=function(){return' "'+this.value+'"'},t}(r),exports.Undefined=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return ct(t,e),t.prototype.isAssignable=T,t.prototype.isComplex=T,t.prototype.compileNode=function(e){return e.level>=b?"(void 0)":"void 0"},t}(r),exports.Null=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return ct(t,e),t.prototype.isAssignable=T,t.prototype.isComplex=T,t.prototype.compileNode=function(){return"null"},t}(r),exports.Bool=function(e){function t(e){this.val=e}return ct(t,e),t.prototype.isAssignable=T,t.prototype.isComplex=T,t.prototype.compileNode=function(){return this.val},t}(r),exports.Return=$=function(e){function t(e){e&&!e.unwrap().isUndefined&&(this.expression=e)}return ct(t,e),t.prototype.children=["expression"],t.prototype.isStatement=J,t.prototype.makeReturn=z,t.prototype.jumps=z,t.prototype.compile=function(e,n){var r,i;return r=null!=(i=this.expression)?i.makeReturn():void 0,!r||r instanceof t?t.__super__.compile.call(this,e,n):r.compile(e,n)},t.prototype.compileNode=function(e){return this.tab+("return"+[this.expression?" "+this.expression.compile(e,k):void 0]+";")},t}(r),exports.Value=G=function(e){function r(e,t,n){return!t&&e instanceof r?e:(this.base=e,this.properties=t||[],n&&(this[n]=!0),this)}return ct(r,e),r.prototype.children=["base","properties"],r.prototype.add=function(e){return this.properties=this.properties.concat(e),this},r.prototype.hasProperties=function(){return!!this.properties.length},r.prototype.isArray=function(){return!this.properties.length&&this.base instanceof t},r.prototype.isComplex=function(){return this.hasProperties()||this.base.isComplex()},r.prototype.isAssignable=function(){return this.hasProperties()||this.base.isAssignable()},r.prototype.isSimpleNumber=function(){return this.base instanceof q&&I.test(this.base.value)},r.prototype.isString=function(){return this.base instanceof q&&m.test(this.base.value)},r.prototype.isAtomic=function(){var e,t,n,r;for(r=this.properties.concat(this.base),t=0,n=r.length;n>t;t++)if(e=r[t],e.soak||e instanceof o)return!1;return!0},r.prototype.isStatement=function(e){return!this.properties.length&&this.base.isStatement(e)},r.prototype.assigns=function(e){return!this.properties.length&&this.base.assigns(e)},r.prototype.jumps=function(e){return!this.properties.length&&this.base.jumps(e)},r.prototype.isObject=function(e){return this.properties.length?!1:this.base instanceof j&&(!e||this.base.generated)},r.prototype.isSplice=function(){return tt(this.properties)instanceof R},r.prototype.unwrap=function(){return this.properties.length?this:this.base},r.prototype.cacheReference=function(e){var t,i,o,a;return o=tt(this.properties),2>this.properties.length&&!this.base.isComplex()&&!(null!=o?o.isComplex():void 0)?[this,this]:(t=new r(this.base,this.properties.slice(0,-1)),t.isComplex()&&(i=new q(e.scope.freeVariable("base")),t=new r(new O(new n(i,t)))),o?(o.isComplex()&&(a=new q(e.scope.freeVariable("name")),o=new y(new n(a,o.index)),a=new y(a)),[t.add(o),new r(i||t.base,[a||o])]):[t,i])},r.prototype.compileNode=function(e){var t,n,r,i,o;for(this.base.front=this.front,r=this.properties,t=this.base.compile(e,r.length?b:null),(this.base instanceof O||r.length)&&I.test(t)&&(t=""+t+"."),i=0,o=r.length;o>i;i++)n=r[i],t+=n.compile(e);return t},r.prototype.unfoldSoak=function(e){var t,i=this;return null!=this.unfoldedSoak?this.unfoldedSoak:(t=function(){var t,o,a,s,u,l,f,p,d;if(a=i.base.unfoldSoak(e))return Array.prototype.push.apply(a.body.properties,i.properties),a;for(d=i.properties,o=f=0,p=d.length;p>f;o=++f)if(s=d[o],s.soak)return s.soak=!1,t=new r(i.base,i.properties.slice(0,o)),l=new r(i.base,i.properties.slice(o)),t.isComplex()&&(u=new q(e.scope.freeVariable("ref")),t=new O(new n(u,t)),l.base=u),new g(new c(t),l,{soak:!0});return null}(),this.unfoldedSoak=t||!1)},r}(r),exports.Comment=l=function(e){function t(e){this.comment=e}return ct(t,e),t.prototype.isStatement=J,t.prototype.makeReturn=z,t.prototype.compileNode=function(e,t){var n;return n="/*"+rt(this.comment,this.tab)+("\n"+this.tab+"*/\n"),(t||e.level)===E&&(n=e.indent+n),n},t}(r),exports.Call=o=function(t){function r(e,t,n){this.args=null!=t?t:[],this.soak=n,this.isNew=!1,this.isSuper="super"===e,this.variable=this.isSuper?null:e}return ct(r,t),r.prototype.children=["variable","args"],r.prototype.newInstance=function(){var e,t;return e=(null!=(t=this.variable)?t.base:void 0)||this.variable,e instanceof r&&!e.isNew?e.newInstance():this.isNew=!0,this},r.prototype.superReference=function(t){var n,r,i;if(r=t.scope.namedMethod(),!r)throw SyntaxError("cannot call super outside of a function.");if(i=r.name,null==i)throw SyntaxError("cannot call super on an anonymous function.");return r.klass?(n=[new e(new q("__super__"))],r["static"]&&n.push(new e(new q("constructor"))),n.push(new e(new q(i))),new G(new q(r.klass),n).compile(t)):""+i+".__super__.constructor"},r.prototype.superThis=function(e){var t;return t=e.scope.method,t&&!t.klass&&t.context||"this"},r.prototype.unfoldSoak=function(e){var t,n,i,o,a,s,u,l,c;if(this.soak){if(this.variable){if(n=ot(e,this,"variable"))return n;l=new G(this.variable).cacheReference(e),i=l[0],a=l[1]}else i=new q(this.superReference(e)),a=new G(i);return a=new r(a,this.args),a.isNew=this.isNew,i=new q("typeof "+i.compile(e)+' === "function"'),new g(i,new G(a),{soak:!0})}for(t=this,o=[];;)if(t.variable instanceof r)o.push(t),t=t.variable;else{if(!(t.variable instanceof G))break;if(o.push(t),!((t=t.variable.base)instanceof r))break}for(c=o.reverse(),s=0,u=c.length;u>s;s++)t=c[s],n&&(t.variable instanceof r?t.variable=n:t.variable.base=n),n=ot(e,t,"variable");return n},r.prototype.filterImplicitObjects=function(e){var t,r,i,o,a,s,u,c,f,p;for(r=[],s=0,c=e.length;c>s;s++)if(t=e[s],("function"==typeof t.isObject?t.isObject():void 0)&&t.base.generated)for(i=null,p=t.base.properties,u=0,f=p.length;f>u;u++)o=p[u],o instanceof n||o instanceof l?(i||r.push(i=new j(a=[],!0)),a.push(o)):(r.push(o),i=null);else r.push(t);return r},r.prototype.compileNode=function(e){var t,n,r,i;return null!=(i=this.variable)&&(i.front=this.front),(r=B.compileSplattedArray(e,this.args,!0))?this.compileSplat(e,r):(n=this.filterImplicitObjects(this.args),n=function(){var r,i,o;for(o=[],r=0,i=n.length;i>r;r++)t=n[r],o.push(t.compile(e,_));return o}().join(", "),this.isSuper?this.superReference(e)+(".call("+this.superThis(e)+(n&&", "+n)+")"):(this.isNew?"new ":"")+this.variable.compile(e,b)+("("+n+")"))},r.prototype.compileSuper=function(e,t){return""+this.superReference(t)+".call("+this.superThis(t)+(e.length?", ":"")+e+")"},r.prototype.compileSplat=function(e,t){var n,r,i,o,a;return this.isSuper?""+this.superReference(e)+".apply("+this.superThis(e)+", "+t+")":this.isNew?(i=this.tab+H,"(function(func, args, ctor) {\n"+i+"ctor.prototype = func.prototype;\n"+i+"var child = new ctor, result = func.apply(child, args), t = typeof result;\n"+i+'return t == "object" || t == "function" ? result || child : child;\n'+this.tab+"})("+this.variable.compile(e,_)+", "+t+", function(){})"):(n=new G(this.variable),(o=n.properties.pop())&&n.isComplex()?(a=e.scope.freeVariable("ref"),r="("+a+" = "+n.compile(e,_)+")"+o.compile(e)):(r=n.compile(e,b),I.test(r)&&(r="("+r+")"),o?(a=r,r+=o.compile(e)):a="null"),""+r+".apply("+a+", "+t+")")},r}(r),exports.Extends=f=function(e){function t(e,t){this.child=e,this.parent=t}return ct(t,e),t.prototype.children=["child","parent"],t.prototype.compile=function(e){return new o(new G(new q(at("extends"))),[this.child,this.parent]).compile(e)},t}(r),exports.Access=e=function(e){function t(e,t){this.name=e,this.name.asKey=!0,this.soak="soak"===t}return ct(t,e),t.prototype.children=["name"],t.prototype.compile=function(e){var t;return t=this.name.compile(e),d.test(t)?"."+t:"["+t+"]"},t.prototype.isComplex=T,t}(r),exports.Index=y=function(e){function t(e){this.index=e}return ct(t,e),t.prototype.children=["index"],t.prototype.compile=function(e){return"["+this.index.compile(e,k)+"]"},t.prototype.isComplex=function(){return this.index.isComplex()},t}(r),exports.Range=L=function(e){function t(e,t,n){this.from=e,this.to=t,this.exclusive="exclusive"===n,this.equals=this.exclusive?"":"="}return ct(t,e),t.prototype.children=["from","to"],t.prototype.compileVariables=function(e){var t,n,r,i,o;return e=nt(e,{top:!0}),n=this.from.cache(e,_),this.fromC=n[0],this.fromVar=n[1],r=this.to.cache(e,_),this.toC=r[0],this.toVar=r[1],(t=Y(e,"step"))&&(i=t.cache(e,_),this.step=i[0],this.stepVar=i[1]),o=[this.fromVar.match(I),this.toVar.match(I)],this.fromNum=o[0],this.toNum=o[1],this.stepVar?this.stepNum=this.stepVar.match(I):void 0},t.prototype.compileNode=function(e){var t,n,r,i,o,a,s,u,l,c,f,p,d,h;return this.fromVar||this.compileVariables(e),e.index?(s=this.fromNum&&this.toNum,o=Y(e,"index"),a=Y(e,"name"),l=a&&a!==o,p=""+o+" = "+this.fromC,this.toC!==this.toVar&&(p+=", "+this.toC),this.step!==this.stepVar&&(p+=", "+this.step),d=[""+o+" <"+this.equals,""+o+" >"+this.equals],u=d[0],i=d[1],n=this.stepNum?+this.stepNum>0?""+u+" "+this.toVar:""+i+" "+this.toVar:s?(h=[+this.fromNum,+this.toNum],r=h[0],f=h[1],h,f>=r?""+u+" "+f:""+i+" "+f):(t=""+this.fromVar+" <= "+this.toVar,""+t+" ? "+u+" "+this.toVar+" : "+i+" "+this.toVar),c=this.stepVar?""+o+" += "+this.stepVar:s?l?f>=r?"++"+o:"--"+o:f>=r?""+o+"++":""+o+"--":l?""+t+" ? ++"+o+" : --"+o:""+t+" ? "+o+"++ : "+o+"--",l&&(p=""+a+" = "+p),l&&(c=""+a+" = "+c),""+p+"; "+n+"; "+c):this.compileArray(e)},t.prototype.compileArray=function(e){var t,n,r,i,o,a,s,u,l,c,f,p,d;return this.fromNum&&this.toNum&&20>=Math.abs(this.fromNum-this.toNum)?(l=function(){d=[];for(var e=p=+this.fromNum,t=+this.toNum;t>=p?t>=e:e>=t;t>=p?e++:e--)d.push(e);return d}.apply(this),this.exclusive&&l.pop(),"["+l.join(", ")+"]"):(a=this.tab+H,o=e.scope.freeVariable("i"),c=e.scope.freeVariable("results"),u="\n"+a+c+" = [];",this.fromNum&&this.toNum?(e.index=o,n=this.compileNode(e)):(f=""+o+" = "+this.fromC+(this.toC!==this.toVar?", "+this.toC:""),r=""+this.fromVar+" <= "+this.toVar,n="var "+f+"; "+r+" ? "+o+" <"+this.equals+" "+this.toVar+" : "+o+" >"+this.equals+" "+this.toVar+"; "+r+" ? "+o+"++ : "+o+"--"),s="{ "+c+".push("+o+"); }\n"+a+"return "+c+";\n"+e.indent,i=function(e){return null!=e?e.contains(function(e){return e instanceof q&&"arguments"===e.value&&!e.asKey}):void 0},(i(this.from)||i(this.to))&&(t=", arguments"),"(function() {"+u+"\n"+a+"for ("+n+")"+s+"}).apply(this"+(null!=t?t:"")+")")},t}(r),exports.Slice=R=function(e){function t(e){this.range=e,t.__super__.constructor.call(this)}return ct(t,e),t.prototype.children=["range"],t.prototype.compileNode=function(e){var t,n,r,i,o,a;return a=this.range,i=a.to,n=a.from,r=n&&n.compile(e,k)||"0",t=i&&i.compile(e,k),i&&(this.range.exclusive||-1!==+t)&&(o=", "+(this.range.exclusive?t:I.test(t)?""+(+t+1):(t=i.compile(e,b),""+t+" + 1 || 9e9"))),".slice("+r+(o||"")+")"},t}(r),exports.Obj=j=function(e){function t(e,t){this.generated=null!=t?t:!1,this.objects=this.properties=e||[]}return ct(t,e),t.prototype.children=["properties"],t.prototype.compileNode=function(e){var t,r,i,o,a,s,u,c,f,p,d,h,m,g,v,y;for(d=this.properties,p=[],y=this.properties,h=0,g=y.length;g>h;h++)if(c=y[h],c.isComplex()&&(c=c.variable),null!=c){if(f=""+c.unwrapAll().value,ft.call(p,f)>=0)throw SyntaxError('multiple object literal properties named "'+f+'"');p.push(f)}if(!d.length)return this.front?"({})":"{}";if(this.generated)for(m=0,v=d.length;v>m;m++)if(s=d[m],s instanceof G)throw Error("cannot have an implicit value in an implicit object");return r=e.indent+=H,a=this.lastNonComment(this.properties),d=function(){var s,u,f;for(f=[],t=s=0,u=d.length;u>s;t=++s)c=d[t],o=t===d.length-1?"":c===a||c instanceof l?"\n":",\n",i=c instanceof l?"":r,c instanceof G&&c["this"]&&(c=new n(c.properties[0].name,c,"object")),c instanceof l||(c instanceof n||(c=new n(c,c,"object")),(c.variable.base||c.variable).asKey=!0),f.push(i+c.compile(e,E)+o);return f}(),d=d.join(""),u="{"+(d&&"\n"+d+"\n"+this.tab)+"}",this.front?"("+u+")":u},t.prototype.assigns=function(e){var t,n,r,i;for(i=this.properties,n=0,r=i.length;r>n;n++)if(t=i[n],t.assigns(e))return!0;return!1},t}(r),exports.Arr=t=function(e){function t(e){this.objects=e||[]}return ct(t,e),t.prototype.children=["objects"],t.prototype.filterImplicitObjects=o.prototype.filterImplicitObjects,t.prototype.compileNode=function(e){var t,n,r;return this.objects.length?(e.indent+=H,r=this.filterImplicitObjects(this.objects),(t=B.compileSplattedArray(e,r))?t:(t=function(){var t,i,o;for(o=[],t=0,i=r.length;i>t;t++)n=r[t],o.push(n.compile(e,_));return o}().join(", "),t.indexOf("\n")>=0?"[\n"+e.indent+t+"\n"+this.tab+"]":"["+t+"]")):"[]"},t.prototype.assigns=function(e){var t,n,r,i;for(i=this.objects,n=0,r=i.length;r>n;n++)if(t=i[n],t.assigns(e))return!0;return!1},t}(r),exports.Class=a=function(t){function r(e,t,n){this.variable=e,this.parent=t,this.body=null!=n?n:new i,this.boundFuncs=[],this.body.classBody=!0}return ct(r,t),r.prototype.children=["variable","parent","body"],r.prototype.determineName=function(){var t,n;if(!this.variable)return null;if(t=(n=tt(this.variable.properties))?n instanceof e&&n.name.value:this.variable.base.value,ft.call(D,t)>=0)throw SyntaxError("variable name may not be "+t);return t&&(t=d.test(t)&&t)},r.prototype.setContext=function(e){return this.body.traverseChildren(!1,function(t){return t.classBody?!1:t instanceof q&&"this"===t.value?t.value=e:t instanceof u&&(t.klass=e,t.bound)?t.context=e:void 0})},r.prototype.addBoundFunctions=function(t){var n,r,i,o,a,s;if(this.boundFuncs.length){for(a=this.boundFuncs,s=[],i=0,o=a.length;o>i;i++)n=a[i],r=new G(new q("this"),[new e(n)]).compile(t),s.push(this.ctor.body.unshift(new q(""+r+" = "+at("bind")+"("+r+", this)")));return s}},r.prototype.addProperties=function(t,r,i){var o,a,s,l,c;return c=t.base.properties.slice(0),s=function(){var t;for(t=[];o=c.shift();){if(o instanceof n)if(a=o.variable.base,delete o.context,l=o.value,"constructor"===a.value){if(this.ctor)throw Error("cannot define more than one constructor in a class");if(l.bound)throw Error("cannot define a constructor as a bound function");l instanceof u?o=this.ctor=l:(this.externalCtor=i.scope.freeVariable("class"),o=new n(new q(this.externalCtor),l))}else o.variable["this"]?(l["static"]=!0,l.bound&&(l.context=r)):(o.variable=new G(new q(r),[new e(new q("prototype")),new e(a)]),l instanceof u&&l.bound&&(this.boundFuncs.push(a),l.bound=!1));t.push(o)}return t}.call(this),K(s)},r.prototype.walkBody=function(e,t){var n=this;return this.traverseChildren(!1,function(o){var a,s,u,l,c,f;if(o instanceof r)return!1;if(o instanceof i){for(f=a=o.expressions,s=l=0,c=f.length;c>l;s=++l)u=f[s],u instanceof G&&u.isObject(!0)&&(a[s]=n.addProperties(u,e,t));return o.expressions=a=et(a)}})},r.prototype.hoistDirectivePrologue=function(){var e,t,n;for(t=0,e=this.body.expressions;(n=e[t])&&n instanceof l||n instanceof G&&n.isString();)++t;return this.directives=e.splice(0,t)},r.prototype.ensureConstructor=function(e){return this.ctor||(this.ctor=new u,this.parent&&this.ctor.body.push(new q(""+e+".__super__.constructor.apply(this, arguments)")),this.externalCtor&&this.ctor.body.push(new q(""+this.externalCtor+".apply(this, arguments)")),this.ctor.body.makeReturn(),this.body.expressions.unshift(this.ctor)),this.ctor.ctor=this.ctor.name=e,this.ctor.klass=null,this.ctor.noReturn=!0},r.prototype.compileNode=function(e){var t,r,i,o,a,l,c;return r=this.determineName(),a=r||"_Class",a.reserved&&(a="_"+a),o=new q(a),this.hoistDirectivePrologue(),this.setContext(a),this.walkBody(a,e),this.ensureConstructor(a),this.body.spaced=!0,this.ctor instanceof u||this.body.expressions.unshift(this.ctor),this.body.expressions.push(o),(c=this.body.expressions).unshift.apply(c,this.directives),this.addBoundFunctions(e),t=s.wrap(this.body),this.parent&&(this.superClass=new q(e.scope.freeVariable("super",!1)),this.body.expressions.unshift(new f(o,this.superClass)),t.args.push(this.parent),l=t.variable.params||t.variable.base.params,l.push(new N(this.superClass))),i=new O(t,!0),this.variable&&(i=new n(this.variable,i)),i.compile(e)},r}(r),exports.Assign=n=function(t){function n(e,t,n,r){var i,o,a;if(this.variable=e,this.value=t,this.context=n,this.param=r&&r.param,this.subpattern=r&&r.subpattern,a=o=this.variable.unwrapAll().value,i=ft.call(D,a)>=0,i&&"object"!==this.context)throw SyntaxError('variable name may not be "'+o+'"')}return ct(n,t),n.prototype.children=["variable","value"],n.prototype.isStatement=function(e){return(null!=e?e.level:void 0)===E&&null!=this.context&&ft.call(this.context,"?")>=0},n.prototype.assigns=function(e){return this["object"===this.context?"value":"variable"].assigns(e)},n.prototype.unfoldSoak=function(e){return ot(e,this,"variable")},n.prototype.compileNode=function(e){var t,n,r,i,o,a,s,l,c;if(t=this.variable instanceof G){if(this.variable.isArray()||this.variable.isObject())return this.compilePatternMatch(e);if(this.variable.isSplice())return this.compileSplice(e);if("||="===(a=this.context)||"&&="===a||"?="===a)return this.compileConditional(e)}if(r=this.variable.compile(e,_),!this.context){if(!(o=this.variable.unwrapAll()).isAssignable())throw SyntaxError('"'+this.variable.compile(e)+'" cannot be assigned.');("function"==typeof o.hasProperties?o.hasProperties():void 0)||(this.param?e.scope.add(r,"var"):e.scope.find(r))}return this.value instanceof u&&(n=S.exec(r))&&(n[1]&&(this.value.klass=n[1]),this.value.name=null!=(s=null!=(l=null!=(c=n[2])?c:n[3])?l:n[4])?s:n[5]),i=this.value.compile(e,_),"object"===this.context?""+r+": "+i:(i=r+(" "+(this.context||"=")+" ")+i,_>=e.level?i:"("+i+")")},n.prototype.compilePatternMatch=function(t){var r,i,o,a,s,u,l,c,f,p,h,m,g,v,b,w,k,S,A,T,j,C,N,L,$,I,D;if(b=t.level===E,k=this.value,p=this.variable.base.objects,!(h=p.length))return o=k.compile(t),t.level>=x?"("+o+")":o;if(u=this.variable.isObject(),b&&1===h&&!((f=p[0])instanceof B)){if(f instanceof n?(j=f,C=j.variable,s=C.base,f=j.value):f.base instanceof O?(N=new G(f.unwrapAll()).cacheReference(t),f=N[0],s=N[1]):s=u?f["this"]?f.properties[0].name:f:new q(0),r=d.test(s.unwrap().value||0),k=new G(k),k.properties.push(new(r?e:y)(s)),L=f.unwrap().value,ft.call(M,L)>=0)throw new SyntaxError("assignment to a reserved word: "+f.compile(t)+" = "+k.compile(t));return new n(f,k,null,{param:this.param}).compile(t,E)}for(S=k.compile(t,_),i=[],v=!1,(!d.test(S)||this.variable.assigns(S))&&(i.push(""+(m=t.scope.freeVariable("ref"))+" = "+S),S=m),a=A=0,T=p.length;T>A;a=++A){if(f=p[a],s=a,u&&(f instanceof n?($=f,I=$.variable,s=I.base,f=$.value):f.base instanceof O?(D=new G(f.unwrapAll()).cacheReference(t),f=D[0],s=D[1]):s=f["this"]?f.properties[0].name:f),!v&&f instanceof B)c=f.name.unwrap().value,f=f.unwrap(),w=""+h+" <= "+S+".length ? "+at("slice")+".call("+S+", "+a,(g=h-a-1)?(l=t.scope.freeVariable("i"),w+=", "+l+" = "+S+".length - "+g+") : ("+l+" = "+a+", [])"):w+=") : []",w=new q(w),v=""+l+"++";else{if(c=f.unwrap().value,f instanceof B)throw f=f.name.compile(t),new SyntaxError("multiple splats are disallowed in an assignment: "+f+"...");"number"==typeof s?(s=new q(v||s),r=!1):r=u&&d.test(s.unwrap().value||0),w=new G(new q(S),[new(r?e:y)(s)])}if(null!=c&&ft.call(M,c)>=0)throw new SyntaxError("assignment to a reserved word: "+f.compile(t)+" = "+w.compile(t));i.push(new n(f,w,null,{param:this.param,subpattern:!0}).compile(t,_))}return b||this.subpattern||i.push(S),o=i.join(", "),_>t.level?o:"("+o+")"},n.prototype.compileConditional=function(e){var t,r,i;if(i=this.variable.cacheReference(e),t=i[0],r=i[1],!t.properties.length&&t.base instanceof q&&"this"!==t.base.value&&!e.scope.check(t.base.value))throw Error('the variable "'+t.base.value+"\" can't be assigned with "+this.context+" because it has not been defined.");return ft.call(this.context,"?")>=0&&(e.isExistentialEquals=!0),new C(this.context.slice(0,-1),t,new n(r,this.value,"=")).compile(e)},n.prototype.compileSplice=function(e){var t,n,r,i,o,a,s,u,l,c,f,p;return c=this.variable.properties.pop().range,r=c.from,s=c.to,n=c.exclusive,a=this.variable.compile(e),f=(null!=r?r.cache(e,x):void 0)||["0","0"],i=f[0],o=f[1],s?(null!=r?r.isSimpleNumber():void 0)&&s.isSimpleNumber()?(s=+s.compile(e)-+o,n||(s+=1)):(s=s.compile(e,b)+" - "+o,n||(s+=" + 1")):s="9e9",p=this.value.cache(e,_),u=p[0],l=p[1],t="[].splice.apply("+a+", ["+i+", "+s+"].concat("+u+")), "+l,e.level>E?"("+t+")":t},n}(r),exports.Code=u=function(e){function r(e,t,n){this.params=e||[],this.body=t||new i,this.bound="boundfunc"===n,this.bound&&(this.context="_this")}return ct(r,e),r.prototype.children=["params","body"],r.prototype.isStatement=function(){return!!this.ctor},r.prototype.jumps=T,r.prototype.compileNode=function(e){var r,i,o,a,s,u,l,c,f,p,d,h,m,v,y,w,_,x,k,E,S,A,T,j,N,O,M,L,$,I,D,R,B;for(e.scope=new F(e.scope,this.body,this),e.scope.shared=Y(e,"sharedScope"),e.indent+=H,delete e.bare,delete e.isExistentialEquals,f=[],i=[],M=this.paramNames(),y=0,k=M.length;k>y;y++)u=M[y],e.scope.check(u)||e.scope.parameter(u);for(L=this.params,w=0,E=L.length;E>w;w++)if(c=L[w],c.splat){for($=this.params,_=0,S=$.length;S>_;_++)l=$[_].name,l["this"]&&(l=l.properties[0].name),l.value&&e.scope.add(l.value,"var",!0);d=new n(new G(new t(function(){var t,n,r,i;for(r=this.params,i=[],t=0,n=r.length;n>t;t++)l=r[t],i.push(l.asReference(e));return i}.call(this))),new G(new q("arguments")));break}for(I=this.params,x=0,A=I.length;A>x;x++)c=I[x],c.isComplex()?(m=p=c.asReference(e),c.value&&(m=new C("?",p,c.value)),i.push(new n(new G(c.name),m,"=",{param:!0}))):(p=c,c.value&&(s=new q(p.name.value+" == null"),m=new n(new G(c.name),c.value,"="),i.push(new g(s,m)))),d||f.push(p);for(v=this.body.isEmpty(),d&&i.unshift(d),i.length&&(D=this.body.expressions).unshift.apply(D,i),o=N=0,T=f.length;T>N;o=++N)l=f[o],e.scope.parameter(f[o]=l.compile(e));for(h=[],R=this.paramNames(),O=0,j=R.length;j>O;O++){if(u=R[O],ft.call(h,u)>=0)throw SyntaxError("multiple parameters named '"+u+"'");h.push(u)}return v||this.noReturn||this.body.makeReturn(),this.bound&&((null!=(B=e.scope.parent.method)?B.bound:void 0)?this.bound=this.context=e.scope.parent.method.context:this["static"]||e.scope.parent.assign("_this","this")),a=e.indent,r="function",this.ctor&&(r+=" "+this.name),r+="("+f.join(", ")+") {",this.body.isEmpty()||(r+="\n"+this.body.compileWithDeclarations(e)+"\n"+this.tab),r+="}",this.ctor?this.tab+r:this.front||e.level>=b?"("+r+")":r},r.prototype.paramNames=function(){var e,t,n,r,i;for(e=[],i=this.params,n=0,r=i.length;r>n;n++)t=i[n],e.push.apply(e,t.names());return e},r.prototype.traverseChildren=function(e,t){return e?r.__super__.traverseChildren.call(this,e,t):void 0},r}(r),exports.Param=N=function(e){function t(e,t,n){var r;if(this.name=e,this.value=t,this.splat=n,r=e=this.name.unwrapAll().value,ft.call(D,r)>=0)throw SyntaxError('parameter name "'+e+'" is not allowed')}return ct(t,e),t.prototype.children=["name","value"],t.prototype.compile=function(e){return this.name.compile(e,_)},t.prototype.asReference=function(e){var t;return this.reference?this.reference:(t=this.name,t["this"]?(t=t.properties[0].name,t.value.reserved&&(t=new q(e.scope.freeVariable(t.value)))):t.isComplex()&&(t=new q(e.scope.freeVariable("arg"))),t=new G(t),this.splat&&(t=new B(t)),this.reference=t)},t.prototype.isComplex=function(){return this.name.isComplex()},t.prototype.names=function(e){var t,r,i,o,a,s;if(null==e&&(e=this.name),t=function(e){var t;return t=e.properties[0].name.value,t.reserved?[]:[t]},e instanceof q)return[e.value];if(e instanceof G)return t(e);for(r=[],s=e.objects,o=0,a=s.length;a>o;o++)if(i=s[o],i instanceof n)r.push(i.value.unwrap().value);else if(i instanceof B)r.push(i.name.unwrap().value);else{if(!(i instanceof G))throw SyntaxError("illegal parameter "+i.compile());i.isArray()||i.isObject()?r.push.apply(r,this.names(i.base)):i["this"]?r.push.apply(r,t(i)):r.push(i.base.value)}return r},t}(r),exports.Splat=B=function(e){function t(e){this.name=e.compile?e:new q(e)}return ct(t,e),t.prototype.children=["name"],t.prototype.isAssignable=J,t.prototype.assigns=function(e){return this.name.assigns(e)},t.prototype.compile=function(e){return null!=this.index?this.compileParam(e):this.name.compile(e)},t.prototype.unwrap=function(){return this.name},t.compileSplattedArray=function(e,n,r){var i,o,a,s,u,l,c,f;for(u=-1;(l=n[++u])&&!(l instanceof t););if(u>=n.length)return"";if(1===n.length)return a=n[0].compile(e,_),r?a:""+at("slice")+".call("+a+")";for(i=n.slice(u),s=c=0,f=i.length;f>c;s=++c)l=i[s],a=l.compile(e,_),i[s]=l instanceof t?""+at("slice")+".call("+a+")":"["+a+"]";return 0===u?i[0]+(".concat("+i.slice(1).join(", ")+")"):(o=function(){var t,r,i,o;for(i=n.slice(0,u),o=[],t=0,r=i.length;r>t;t++)l=i[t],o.push(l.compile(e,_));return o}(),"["+o.join(", ")+"].concat("+i.join(", ")+")")},t}(r),exports.While=X=function(e){function t(e,t){this.condition=(null!=t?t.invert:void 0)?e.invert():e,this.guard=null!=t?t.guard:void 0}return ct(t,e),t.prototype.children=["condition","guard","body"],t.prototype.isStatement=J,t.prototype.makeReturn=function(e){return e?t.__super__.makeReturn.apply(this,arguments):(this.returns=!this.jumps({loop:!0}),this)},t.prototype.addBody=function(e){return this.body=e,this},t.prototype.jumps=function(){var e,t,n,r;if(e=this.body.expressions,!e.length)return!1;for(n=0,r=e.length;r>n;n++)if(t=e[n],t.jumps({loop:!0}))return t;
return!1},t.prototype.compileNode=function(e){var t,n,r,o;return e.indent+=H,o="",t=this.body,t.isEmpty()?t="":(this.returns&&(t.makeReturn(r=e.scope.freeVariable("results")),o=""+this.tab+r+" = [];\n"),this.guard&&(t.expressions.length>1?t.expressions.unshift(new g(new O(this.guard).invert(),new q("continue"))):this.guard&&(t=i.wrap([new g(this.guard,t)]))),t="\n"+t.compile(e,E)+"\n"+this.tab),n=o+this.tab+("while ("+this.condition.compile(e,k)+") {"+t+"}"),this.returns&&(n+="\n"+this.tab+"return "+r+";"),n},t}(r),exports.Op=C=function(e){function t(e,t,n,i){if("in"===e)return new v(t,n);if("do"===e)return this.generateDo(t);if("new"===e){if(t instanceof o&&!t["do"]&&!t.isNew)return t.newInstance();(t instanceof u&&t.bound||t["do"])&&(t=new O(t))}return this.operator=r[e]||e,this.first=t,this.second=n,this.flip=!!i,this}var r,i;return ct(t,e),r={"==":"===","!=":"!==",of:"in"},i={"!==":"===","===":"!=="},t.prototype.children=["first","second"],t.prototype.isSimpleNumber=T,t.prototype.isUnary=function(){return!this.second},t.prototype.isComplex=function(){var e;return!(this.isUnary()&&("+"===(e=this.operator)||"-"===e))||this.first.isComplex()},t.prototype.isChainable=function(){var e;return"<"===(e=this.operator)||">"===e||">="===e||"<="===e||"==="===e||"!=="===e},t.prototype.invert=function(){var e,n,r,o,a;if(this.isChainable()&&this.first.isChainable()){for(e=!0,n=this;n&&n.operator;)e&&(e=n.operator in i),n=n.first;if(!e)return new O(this).invert();for(n=this;n&&n.operator;)n.invert=!n.invert,n.operator=i[n.operator],n=n.first;return this}return(o=i[this.operator])?(this.operator=o,this.first.unwrap()instanceof t&&this.first.invert(),this):this.second?new O(this).invert():"!"===this.operator&&(r=this.first.unwrap())instanceof t&&("!"===(a=r.operator)||"in"===a||"instanceof"===a)?r:new t("!",this)},t.prototype.unfoldSoak=function(e){var t;return("++"===(t=this.operator)||"--"===t||"delete"===t)&&ot(e,this,"first")},t.prototype.generateDo=function(e){var t,r,i,a,s,l,c,f;for(a=[],r=e instanceof n&&(s=e.value.unwrap())instanceof u?s:e,f=r.params||[],l=0,c=f.length;c>l;l++)i=f[l],i.value?(a.push(i.value),delete i.value):a.push(i);return t=new o(e,a),t["do"]=!0,t},t.prototype.compileNode=function(e){var t,n,r,i;if(n=this.isChainable()&&this.first.isChainable(),n||(this.first.front=this.front),"delete"===this.operator&&e.scope.check(this.first.unwrapAll().value))throw SyntaxError("delete operand may not be argument or var");if(("--"===(r=this.operator)||"++"===r)&&(i=this.first.unwrapAll().value,ft.call(D,i)>=0))throw SyntaxError("prefix increment/decrement may not have eval or arguments operand");return this.isUnary()?this.compileUnary(e):n?this.compileChain(e):"?"===this.operator?this.compileExistence(e):(t=this.first.compile(e,x)+" "+this.operator+" "+this.second.compile(e,x),x>=e.level?t:"("+t+")")},t.prototype.compileChain=function(e){var t,n,r,i;return i=this.first.second.cache(e),this.first.second=i[0],r=i[1],n=this.first.compile(e,x),t=""+n+" "+(this.invert?"&&":"||")+" "+r.compile(e)+" "+this.operator+" "+this.second.compile(e,x),"("+t+")"},t.prototype.compileExistence=function(e){var t,r;return this.first.isComplex()?(r=new q(e.scope.freeVariable("ref")),t=new O(new n(r,this.first))):(t=this.first,r=t),new g(new c(t),r,{type:"if"}).addElse(this.second).compile(e)},t.prototype.compileUnary=function(e){var n,r,i;return e.level>=b?new O(this).compile(e):(r=[n=this.operator],i="+"===n||"-"===n,("new"===n||"typeof"===n||"delete"===n||i&&this.first instanceof t&&this.first.operator===n)&&r.push(" "),(i&&this.first instanceof t||"new"===n&&this.first.isStatement(e))&&(this.first=new O(this.first)),r.push(this.first.compile(e,x)),this.flip&&r.reverse(),r.join(""))},t.prototype.toString=function(e){return t.__super__.toString.call(this,e,this.constructor.name+" "+this.operator)},t}(r),exports.In=v=function(e){function t(e,t){this.object=e,this.array=t}return ct(t,e),t.prototype.children=["object","array"],t.prototype.invert=A,t.prototype.compileNode=function(e){var t,n,r,i,o;if(this.array instanceof G&&this.array.isArray()){for(o=this.array.base.objects,r=0,i=o.length;i>r;r++)if(n=o[r],n instanceof B){t=!0;break}if(!t)return this.compileOrTest(e)}return this.compileLoopTest(e)},t.prototype.compileOrTest=function(e){var t,n,r,i,o,a,s,u,l;return 0===this.array.base.objects.length?""+!!this.negated:(u=this.object.cache(e,x),a=u[0],o=u[1],l=this.negated?[" !== "," && "]:[" === "," || "],t=l[0],n=l[1],s=function(){var n,s,u,l;for(u=this.array.base.objects,l=[],r=n=0,s=u.length;s>n;r=++n)i=u[r],l.push((r?o:a)+t+i.compile(e,b));return l}.call(this),s=s.join(n),x>e.level?s:"("+s+")")},t.prototype.compileLoopTest=function(e){var t,n,r,i;return i=this.object.cache(e,_),r=i[0],n=i[1],t=at("indexOf")+(".call("+this.array.compile(e,_)+", "+n+") ")+(this.negated?"< 0":">= 0"),r===n?t:(t=r+", "+t,_>e.level?t:"("+t+")")},t.prototype.toString=function(e){return t.__super__.toString.call(this,e,this.constructor.name+(this.negated?"!":""))},t}(r),exports.Try=W=function(e){function t(e,t,n,r){this.attempt=e,this.error=t,this.recovery=n,this.ensure=r}return ct(t,e),t.prototype.children=["attempt","recovery","ensure"],t.prototype.isStatement=J,t.prototype.jumps=function(e){var t;return this.attempt.jumps(e)||(null!=(t=this.recovery)?t.jumps(e):void 0)},t.prototype.makeReturn=function(e){return this.attempt&&(this.attempt=this.attempt.makeReturn(e)),this.recovery&&(this.recovery=this.recovery.makeReturn(e)),this},t.prototype.compileNode=function(e){var t,n,r,i;return e.indent+=H,r=this.error?" ("+this.error.compile(e)+") ":" ",i=this.attempt.compile(e,E),t=function(){var t;if(this.recovery){if(t=this.error.value,ft.call(D,t)>=0)throw SyntaxError('catch variable may not be "'+this.error.value+'"');return e.scope.check(this.error.value)||e.scope.add(this.error.value,"param")," catch"+r+"{\n"+this.recovery.compile(e,E)+"\n"+this.tab+"}"}return this.ensure||this.recovery?void 0:" catch (_error) {}"}.call(this),n=this.ensure?" finally {\n"+this.ensure.compile(e,E)+"\n"+this.tab+"}":"",""+this.tab+"try {\n"+i+"\n"+this.tab+"}"+(t||"")+n},t}(r),exports.Throw=U=function(e){function t(e){this.expression=e}return ct(t,e),t.prototype.children=["expression"],t.prototype.isStatement=J,t.prototype.jumps=T,t.prototype.makeReturn=z,t.prototype.compileNode=function(e){return this.tab+("throw "+this.expression.compile(e)+";")},t}(r),exports.Existence=c=function(e){function t(e){this.expression=e}return ct(t,e),t.prototype.children=["expression"],t.prototype.invert=A,t.prototype.compileNode=function(e){var t,n,r,i;return this.expression.front=this.front,r=this.expression.compile(e,x),d.test(r)&&!e.scope.check(r)?(i=this.negated?["===","||"]:["!==","&&"],t=i[0],n=i[1],r="typeof "+r+" "+t+' "undefined" '+n+" "+r+" "+t+" null"):r=""+r+" "+(this.negated?"==":"!=")+" null",w>=e.level?r:"("+r+")"},t}(r),exports.Parens=O=function(e){function t(e){this.body=e}return ct(t,e),t.prototype.children=["body"],t.prototype.unwrap=function(){return this.body},t.prototype.isComplex=function(){return this.body.isComplex()},t.prototype.compileNode=function(e){var t,n,r;return r=this.body.unwrap(),r instanceof G&&r.isAtomic()?(r.front=this.front,r.compile(e)):(n=r.compile(e,k),t=x>e.level&&(r instanceof C||r instanceof o||r instanceof p&&r.returns),t?n:"("+n+")")},t}(r),exports.For=p=function(e){function t(e,t){var n;if(this.source=t.source,this.guard=t.guard,this.step=t.step,this.name=t.name,this.index=t.index,this.body=i.wrap([e]),this.own=!!t.own,this.object=!!t.object,this.object&&(n=[this.index,this.name],this.name=n[0],this.index=n[1]),this.index instanceof G)throw SyntaxError("index cannot be a pattern matching expression");if(this.range=this.source instanceof G&&this.source.base instanceof L&&!this.source.properties.length,this.pattern=this.name instanceof G,this.range&&this.index)throw SyntaxError("indexes do not apply to range loops");if(this.range&&this.pattern)throw SyntaxError("cannot pattern match over range loops");this.returns=!1}return ct(t,e),t.prototype.children=["body","source","guard","step"],t.prototype.compileNode=function(e){var t,r,o,a,s,u,l,c,f,p,h,m,v,y,b,w,k,S,A,T,j,C,N,M,L;return t=i.wrap([this.body]),h=null!=(L=tt(t.expressions))?L.jumps():void 0,h&&h instanceof $&&(this.returns=!1),T=this.range?this.source.base:this.source,A=e.scope,v=this.name&&this.name.compile(e,_),l=this.index&&this.index.compile(e,_),v&&!this.pattern&&A.find(v),l&&A.find(l),this.returns&&(S=A.freeVariable("results")),c=this.object&&l||A.freeVariable("i"),f=this.range&&v||l||c,p=f!==c?""+f+" = ":"",this.step&&!this.range&&(C=A.freeVariable("step")),this.pattern&&(v=c),M="",s="",r="",u=this.tab+H,this.range?o=T.compile(nt(e,{index:c,name:v,step:this.step})):(N=this.source.compile(e,_),!v&&!this.own||d.test(N)||(r=""+this.tab+(b=A.freeVariable("ref"))+" = "+N+";\n",N=b),v&&!this.pattern&&(y=""+v+" = "+N+"["+f+"]"),this.object||(m=A.freeVariable("len"),a=""+p+c+" = 0, "+m+" = "+N+".length",this.step&&(a+=", "+C+" = "+this.step.compile(e,x)),j=""+p+(this.step?""+c+" += "+C:f!==c?"++"+c:""+c+"++"),o=""+a+"; "+c+" < "+m+"; "+j)),this.returns&&(w=""+this.tab+S+" = [];\n",k="\n"+this.tab+"return "+S+";",t.makeReturn(S)),this.guard&&(t.expressions.length>1?t.expressions.unshift(new g(new O(this.guard).invert(),new q("continue"))):this.guard&&(t=i.wrap([new g(this.guard,t)]))),this.pattern&&t.expressions.unshift(new n(this.name,new q(""+N+"["+f+"]"))),r+=this.pluckDirectCall(e,t),y&&(M="\n"+u+y+";"),this.object&&(o=""+f+" in "+N,this.own&&(s="\n"+u+"if (!"+at("hasProp")+".call("+N+", "+f+")) continue;")),t=t.compile(nt(e,{indent:u}),E),t&&(t="\n"+t+"\n"),""+r+(w||"")+this.tab+"for ("+o+") {"+s+M+t+this.tab+"}"+(k||"")},t.prototype.pluckDirectCall=function(e,t){var r,i,a,s,l,c,f,p,d,h,m,g,v,y,b;for(i="",h=t.expressions,l=p=0,d=h.length;d>p;l=++p)a=h[l],a=a.unwrapAll(),a instanceof o&&(f=a.variable.unwrapAll(),(f instanceof u||f instanceof G&&(null!=(m=f.base)?m.unwrapAll():void 0)instanceof u&&1===f.properties.length&&("call"===(g=null!=(v=f.properties[0].name)?v.value:void 0)||"apply"===g))&&(s=(null!=(y=f.base)?y.unwrapAll():void 0)||f,c=new q(e.scope.freeVariable("fn")),r=new G(c),f.base&&(b=[r,f],f.base=b[0],r=b[1]),t.expressions[l]=new o(r,a.args),i+=this.tab+new n(c,s).compile(e,E)+";\n"));return i},t}(X),exports.Switch=P=function(e){function t(e,t,n){this.subject=e,this.cases=t,this.otherwise=n}return ct(t,e),t.prototype.children=["subject","cases","otherwise"],t.prototype.isStatement=J,t.prototype.jumps=function(e){var t,n,r,i,o,a,s;for(null==e&&(e={block:!0}),o=this.cases,r=0,i=o.length;i>r;r++)if(a=o[r],n=a[0],t=a[1],t.jumps(e))return t;return null!=(s=this.otherwise)?s.jumps(e):void 0},t.prototype.makeReturn=function(e){var t,n,r,o,a;for(o=this.cases,n=0,r=o.length;r>n;n++)t=o[n],t[1].makeReturn(e);return e&&(this.otherwise||(this.otherwise=new i([new q("void 0")]))),null!=(a=this.otherwise)&&a.makeReturn(e),this},t.prototype.compileNode=function(e){var t,n,r,i,o,a,s,u,l,c,f,p,d,h,m,g,v;for(u=e.indent+H,l=e.indent=u+H,r=this.tab+("switch ("+((null!=(h=this.subject)?h.compile(e,k):void 0)||!1)+") {\n"),m=this.cases,s=c=0,p=m.length;p>c;s=++c){for(g=m[s],o=g[0],t=g[1],v=et([o]),f=0,d=v.length;d>f;f++)i=v[f],this.subject||(i=i.invert()),r+=u+("case "+i.compile(e,k)+":\n");if((n=t.compile(e,E))&&(r+=n+"\n"),s===this.cases.length-1&&!this.otherwise)break;a=this.lastNonComment(t.expressions),a instanceof $||a instanceof q&&a.jumps()&&"debugger"!==a.value||(r+=l+"break;\n")}return this.otherwise&&this.otherwise.expressions.length&&(r+=u+("default:\n"+this.otherwise.compile(e,E)+"\n")),r+this.tab+"}"},t}(r),exports.If=g=function(e){function t(e,t,n){this.body=t,null==n&&(n={}),this.condition="unless"===n.type?e.invert():e,this.elseBody=null,this.isChain=!1,this.soak=n.soak}return ct(t,e),t.prototype.children=["condition","body","elseBody"],t.prototype.bodyNode=function(){var e;return null!=(e=this.body)?e.unwrap():void 0},t.prototype.elseBodyNode=function(){var e;return null!=(e=this.elseBody)?e.unwrap():void 0},t.prototype.addElse=function(e){return this.isChain?this.elseBodyNode().addElse(e):(this.isChain=e instanceof t,this.elseBody=this.ensureBlock(e)),this},t.prototype.isStatement=function(e){var t;return(null!=e?e.level:void 0)===E||this.bodyNode().isStatement(e)||(null!=(t=this.elseBodyNode())?t.isStatement(e):void 0)},t.prototype.jumps=function(e){var t;return this.body.jumps(e)||(null!=(t=this.elseBody)?t.jumps(e):void 0)},t.prototype.compileNode=function(e){return this.isStatement(e)?this.compileStatement(e):this.compileExpression(e)},t.prototype.makeReturn=function(e){return e&&(this.elseBody||(this.elseBody=new i([new q("void 0")]))),this.body&&(this.body=new i([this.body.makeReturn(e)])),this.elseBody&&(this.elseBody=new i([this.elseBody.makeReturn(e)])),this},t.prototype.ensureBlock=function(e){return e instanceof i?e:new i([e])},t.prototype.compileStatement=function(e){var n,r,i,o,a;return r=Y(e,"chainChild"),(o=Y(e,"isExistentialEquals"))?new t(this.condition.invert(),this.elseBodyNode(),{type:"if"}).compile(e):(i=this.condition.compile(e,k),e.indent+=H,n=this.ensureBlock(this.body),a="if ("+i+") {\n"+n.compile(e)+"\n"+this.tab+"}",r||(a=this.tab+a),this.elseBody?a+" else "+(this.isChain?(e.indent=this.tab,e.chainChild=!0,this.elseBody.unwrap().compile(e,E)):"{\n"+this.elseBody.compile(e,E)+"\n"+this.tab+"}"):a)},t.prototype.compileExpression=function(e){var t,n,r,i;return i=this.condition.compile(e,w),n=this.bodyNode().compile(e,_),t=this.elseBodyNode()?this.elseBodyNode().compile(e,_):"void 0",r=""+i+" ? "+n+" : "+t,e.level>=w?"("+r+")":r},t.prototype.unfoldSoak=function(){return this.soak&&this},t}(r),s={wrap:function(t,n,r){var a,s,l,c,f;return t.jumps()?t:(l=new u([],i.wrap([t])),a=[],((c=t.contains(this.literalArgs))||t.contains(this.literalThis))&&(f=new q(c?"apply":"call"),a=[new q("this")],c&&a.push(new q("arguments")),l=new G(l,[new e(f)])),l.noReturn=r,s=new o(l,a),n?i.wrap([s]):s)},literalArgs:function(e){return e instanceof q&&"arguments"===e.value&&!e.asKey},literalThis:function(e){return e instanceof q&&"this"===e.value&&!e.asKey||e instanceof u&&e.bound||e instanceof o&&e.isSuper}},ot=function(e,t,n){var r;if(r=t[n].unfoldSoak(e))return t[n]=r.body,r.body=new G(t),r},V={"extends":function(){return"function(child, parent) { for (var key in parent) { if ("+at("hasProp")+".call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }"},bind:function(){return"function(fn, me){ return function(){ return fn.apply(me, arguments); }; }"},indexOf:function(){return"[].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; }"},hasProp:function(){return"{}.hasOwnProperty"},slice:function(){return"[].slice"}},E=1,k=2,_=3,w=4,x=5,b=6,H="  ",h="[$A-Za-z_\\x7f-\\uffff][$\\w\\x7f-\\uffff]*",d=RegExp("^"+h+"$"),I=/^[+-]?\d+$/,S=RegExp("^(?:("+h+")\\.prototype(?:\\.("+h+")|\\[(\"(?:[^\\\\\"\\r\\n]|\\\\.)*\"|'(?:[^\\\\'\\r\\n]|\\\\.)*')\\]|\\[(0x[\\da-fA-F]+|\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\]))|("+h+")$"),m=/^['"]/,at=function(e){var t;return t="__"+e,F.root.assign(t,V[e]()),t},rt=function(e,t){return e=e.replace(/\n/g,"$&"+t),e.replace(/\s+$/,"")}}).call(this);