var _=require("underscore");_.str=require("underscore.string");var $$=require("./const"),ActionHelp=require("./action/help"),ActionAppend=require("./action/append"),ActionAppendConstant=require("./action/append/constant"),ActionCount=require("./action/count"),ActionStore=require("./action/store"),ActionStoreConstant=require("./action/store/constant"),ActionStoreTrue=require("./action/store/true"),ActionStoreFalse=require("./action/store/false"),ActionVersion=require("./action/version"),ActionSubparsers=require("./action/subparsers"),argumentErrorHelper=require("./argument/error"),ActionContainer=module.exports=function ActionContainer(e){e=e||{},this.description=e.description,this.argumentDefault=e.argumentDefault,this.prefixChars=e.prefixChars||"",this.conflictHandler=e.conflictHandler,this._registries={},this.register("action",null,ActionStore),this.register("action","store",ActionStore),this.register("action","storeConst",ActionStoreConstant),this.register("action","storeTrue",ActionStoreTrue),this.register("action","storeFalse",ActionStoreFalse),this.register("action","append",ActionAppend),this.register("action","appendConst",ActionAppendConstant),this.register("action","count",ActionCount),this.register("action","help",ActionHelp),this.register("action","version",ActionVersion),this.register("action","parsers",ActionSubparsers),this._getHandler(),this._actions=[],this._optionStringActions={},this._actionGroups=[],this._mutuallyExclusiveGroups=[],this._defaults={},this._regexpNegativeNumber=RegExp("^-\\d+$|^-\\d*\\.\\d+$"),this._hasNegativeNumberOptionals=[]},ArgumentGroup=require("./argument/group"),MutuallyExclusiveGroup=require("./argument/exclusive");ActionContainer.prototype.register=function(e,t,n){this._registries[e]=this._registries[e]||{},this._registries[e][t]=n},ActionContainer.prototype._registryGet=function(e,t,n){return 3>arguments.length&&(n=null),this._registries[e][t]||n},ActionContainer.prototype.setDefaults=function(e){e=e||{};for(var t in e)this._defaults[t]=e[t];this._actions.forEach(function(t){t.dest in e&&(t.defaultValue=e[t.dest])})},ActionContainer.prototype.getDefault=function(e){var t=_.has(this._defaults,e)?this._defaults[e]:null;return this._actions.forEach(function(n){n.dest===e&&_.has(n,"defaultValue")&&(t=n.defaultValue)}),t},ActionContainer.prototype.addArgument=function(e,t){if(e=e,t=t||{},!_.isArray(e))throw new TypeError("addArgument first argument should be an array");if(!_.isObject(t)||_.isArray(t))throw new TypeError("addArgument second argument should be a hash");if(!e||1===e.length&&0>this.prefixChars.indexOf(e[0][0])){if(e&&t.dest)throw Error("dest supplied twice for positional argument");t=this._getPositional(e,t)}else t=this._getOptional(e,t);if(_.isUndefined(t.defaultValue)){var n=t.dest;_.has(this._defaults,n)?t.defaultValue=this._defaults[n]:_.isUndefined(this.argumentDefault)||(t.defaultValue=this.argumentDefault)}var r=this._popActionClass(t);if(!_.isFunction(r))throw Error(_.str.sprintf('Unknown action "%(action)s".',{action:r}));var i=new r(t),o=this._registryGet("type",i.type,i.type);if(!_.isFunction(o))throw Error(_.str.sprintf('"%(function)s" is not callable',{"function":o}));return this._addAction(i)},ActionContainer.prototype.addArgumentGroup=function(e){var t=new ArgumentGroup(this,e);return this._actionGroups.push(t),t},ActionContainer.prototype.addMutuallyExclusiveGroup=function(e){var t=new MutuallyExclusiveGroup(this,e);return this._mutuallyExclusiveGroups.push(t),t},ActionContainer.prototype._addAction=function(e){var t=this;return this._checkConflict(e),this._actions.push(e),e.container=this,e.optionStrings.forEach(function(n){t._optionStringActions[n]=e}),e.optionStrings.forEach(function(e){e.match(t._regexpNegativeNumber)&&(_.any(t._hasNegativeNumberOptionals)||t._hasNegativeNumberOptionals.push(!0))}),e},ActionContainer.prototype._removeAction=function(e){var t=this._actions.indexOf(e);t>=0&&this._actions.splice(t,1)},ActionContainer.prototype._addContainerActions=function(e){function t(e){return e.getName()}var n={};this._actionGroups.forEach(function(e){if(n[e.title])throw Error(_.str.sprintf('Cannot merge actions - two groups are named "%(group.title)s".',e));n[e.title]=e});var r={};e._actionGroups.forEach(function(e){n[e.title]||(n[e.title]=this.addArgumentGroup({title:e.title,description:e.description})),e._groupActions.forEach(function(i){r[t(i)]=n[e.title]})},this);var i;e._mutuallyExclusiveGroups.forEach(function(e){i=this.addMutuallyExclusiveGroup({required:e.required}),e._groupActions.forEach(function(e){r[t(e)]=i})},this),e._actions.forEach(function(e){var n=t(e);r[n]?r[n]._addAction(e):this._addAction(e)})},ActionContainer.prototype._getPositional=function(e,t){if(_.isArray(e)&&(e=_.first(e)),t.required)throw Error('"required" is an invalid argument for positionals.');return t.nargs!==$$.OPTIONAL&&t.nargs!==$$.ZERO_OR_MORE&&(t.required=!0),t.nargs===$$.ZERO_OR_MORE&&void 0===t.defaultValue&&(t.required=!0),t.dest=e,t.optionStrings=[],t},ActionContainer.prototype._getOptional=function(e,t){var n=this.prefixChars,r=[],i=[];e.forEach(function(e){if(0>n.indexOf(e[0]))throw Error(_.str.sprintf('Invalid option string "%(option)s": must start with a "%(prefix)s".',{option:e,prefix:n}));r.push(e),e.length>1&&n.indexOf(e[1])>=0&&i.push(e)});var o=t.dest||null;if(delete t.dest,!o){var a=i.length?i[0]:r[0];if(o=_.str.strip(a,this.prefixChars),0===o.length)throw Error(_.str.sprintf('dest= is required for options like "%(option)s"',{option:r.join(", ")}));o=o.replace("-","_")}return t.dest=o,t.optionStrings=r,t},ActionContainer.prototype._popActionClass=function(e,t){t=t||null;var n=e.action||t;delete e.action;var r=this._registryGet("action",n,n);return r},ActionContainer.prototype._getHandler=function(){var e=this.conflictHandler,t="_handleConflict"+_.str.capitalize(e),n=this[t];if(n===void 0){var r="invalid conflict resolution value: "+e;throw Error(r)}return n},ActionContainer.prototype._checkConflict=function(e){var t=this._optionStringActions,n=[];if(e.optionStrings.forEach(function(e){var r=t[e];r!==void 0&&n.push([e,r])}),n.length>0){var r=this._getHandler();r.call(this,e,n)}},ActionContainer.prototype._handleConflictError=function(e,t){var n=_.map(t,function(e){return e[0]});throw n=n.join(", "),argumentErrorHelper(e,_.str.sprintf("Conflicting option string(s): %(conflict)s",{conflict:n}))},ActionContainer.prototype._handleConflictResolve=function(e,t){var n=this;t.forEach(function(e){var t=e[0],r=e[1],i=r.optionStrings.indexOf(t);i>=0&&r.optionStrings.splice(i,1),delete n._optionStringActions[t],0===r.optionStrings.length&&r.container._removeAction(r)})};