(function(){var e,t,n,r,i,o,a,s,u,l,c,f,d,p,h,m,g,v,y,b,w,_,x,k,E,q,S,A,T,j,C,N,O,M,L,$,I,D,F,R,B;f=require("fs"),k=require("path"),d=require("./helpers"),b=require("./optparse"),t=require("./coffee-script"),B=require("child_process"),C=B.spawn,l=B.exec,n=require("events").EventEmitter,d.extend(t,new n),E=function(e){return process.stdout.write(e+"\n")},S=function(e){return process.stderr.write(e+"\n")},p=function(e){return/^\.|~$/.test(e)},e="Usage: coffee [options] path/to/script.coffee -- [args]\n\nIf called without options, `coffee` will run your script.",r=[["-b","--bare","compile without a top-level function wrapper"],["-c","--compile","compile to JavaScript and save as .js files"],["-e","--eval","pass a string from the command line as input"],["-h","--help","display this help message"],["-i","--interactive","run an interactive CoffeeScript REPL"],["-j","--join [FILE]","concatenate the source CoffeeScript before compiling"],["-l","--lint","pipe the compiled JavaScript through JavaScript Lint"],["-n","--nodes","print out the parse tree that the parser produces"],["--nodejs [ARGS]",'pass options directly to the "node" binary'],["-o","--output [DIR]","set the output directory for compiled JavaScript"],["-p","--print","print out the compiled JavaScript"],["-r","--require [FILE*]","require a library before executing your script"],["-s","--stdio","listen for and compile scripts over stdio"],["-t","--tokens","print out the tokens that the lexer/rewriter produce"],["-v","--version","display the version number"],["-w","--watch","watch scripts for changes and rerun commands"]],w={},j=[],T=[],v={},F={},y=null,exports.run=function(){var e,t,n,r,i;if(x(),w.nodejs)return c();if(w.help)return M();if(w.version)return L();if(w.require&&g(),w.interactive)return require("./repl");if(w.watch&&!f.watch)return S("The --watch feature depends on Node v0.6.0+. You are running "+process.version+".");if(w.stdio)return u();if(w.eval)return s(null,j[0]);if(!j.length)return require("./repl");for(e=w.run?j.splice(1):[],process.argv=process.argv.slice(0,2).concat(e),process.argv[0]="coffee",process.execPath=require.main.filename,i=[],n=0,r=j.length;r>n;n++)t=j[n],i.push(a(t,!0,k.normalize(t)));return i},a=function(e,t,n){return f.stat(e,function(r,i){if(r&&"ENOENT"!==r.code)throw r;return"ENOENT"===(null!=r?r.code:void 0)?t&&".coffee"!==e.slice(-7)?(e=j[j.indexOf(e)]=""+e+".coffee",a(e,t,n)):(t&&(console.error("File not found: "+e),process.exit(1)),void 0):i.isDirectory()?(w.watch&&D(e,n),f.readdir(e,function(t,r){var i,o,s,u;if(t&&"ENOENT"!==t.code)throw t;if("ENOENT"!==(null!=t?t.code:void 0))return o=j.indexOf(e),r=r.filter(function(e){return!p(e)}),[].splice.apply(j,[o,o-o+1].concat(s=function(){var t,n,o;for(o=[],t=0,n=r.length;n>t;t++)i=r[t],o.push(k.join(e,i));return o}())),s,[].splice.apply(T,[o,o-o+1].concat(u=r.map(function(){return null}))),u,r.forEach(function(t){return a(k.join(e,t),!1,n)})})):t||".coffee"===k.extname(e)?(w.watch&&I(e,n),f.readFile(e,function(t,r){if(t&&"ENOENT"!==t.code)throw t;if("ENOENT"!==(null!=t?t.code:void 0))return s(e,""+r,n)})):(v[e]=!0,A(e,n))})},s=function(e,n,r){var a,s,u,l;a=w,s=o(e);try{if(u=l={file:e,input:n,options:s},t.emit("compile",l),a.tokens)return q(t.tokens(u.input));if(a.nodes)return E((""+t.nodes(u.input)).trim());if(a.run)return t.run(u.input,u.options);if(a.join&&u.file!==a.join)return T[j.indexOf(u.file)]=u.input,i();if(u.output=t.compile(u.input,u.options),t.emit("success",l),a.print)return E(u.output.trim());if(a.compile)return R(u.file,u.output,r);if(a.lint)return m(u.file,u.output)}catch(c){if(t.emit("failure",c,l),t.listeners("failure").length)return;return a.watch?E(c.message+""):(S(c instanceof Error&&c.stack||"ERROR: "+c),process.exit(1))}},u=function(){var e,t;return e="",t=process.openStdin(),t.on("data",function(t){return t?e+=""+t:void 0}),t.on("end",function(){return s(null,e)})},h=null,i=function(){return w.join?T.some(function(e){return null===e})?void 0:(clearTimeout(h),h=$(100,function(){return s(w.join,T.join("\n"),w.join)})):void 0},g=function(){var e,t,n,r,i;for(e=module.filename,module.filename=".",i=w.require,n=0,r=i.length;r>n;n++)t=i[n],require(t);return module.filename=e},I=function(e,t){var n,r,o,a,u,l;o=null,r=null,u=function(r){if("ENOENT"!==r.code)throw r;if(-1!==j.indexOf(e))try{return a(),n()}catch(r){return A(e,t,!0),i()}},n=function(){return clearTimeout(r),r=$(25,function(){return f.stat(e,function(n,r){return n?u(n):o&&r.size===o.size&&r.mtime.getTime()===o.mtime.getTime()?a():(o=r,f.readFile(e,function(n,r){return n?u(n):(s(e,""+r,t),a())}))})})};try{l=f.watch(e,n)}catch(c){u(c)}return a=function(){return null!=l&&l.close(),l=f.watch(e,n)}},D=function(e,t){var n,r;n=null;try{return r=f.watch(e,function(){return clearTimeout(n),n=$(25,function(){return f.readdir(e,function(n,i){var o,s,u,l;if(n){if("ENOENT"!==n.code)throw n;return r.close(),O(e,t)}for(l=[],s=0,u=i.length;u>s;s++)o=i[s],p(o)||v[o]||(o=k.join(e,o),j.some(function(e){return e.indexOf(o)>=0})||(j.push(o),T.push(null),l.push(a(o,!1,t))));return l})})})}catch(i){if("ENOENT"!==i.code)throw i}},O=function(e,t){var n,r,o,a,s;for(r=j.slice(0),o=function(){var t,r,i;for(i=[],t=0,r=j.length;r>t;t++)n=j[t],n.indexOf(e)>=0&&i.push(n);return i}(),a=0,s=o.length;s>a;a++)n=o[a],A(n,t,!0);return j.some(function(e,t){return r[t]!==e})?i():void 0},A=function(e,t,n){var r,i;return r=j.indexOf(e),j.splice(r,1),T.splice(r,1),n&&!w.join?(i=_(e,t),k.exists(i,function(t){return t?f.unlink(i,function(t){if(t&&"ENOENT"!==t.code)throw t;return N("removed "+e)}):void 0})):void 0},_=function(e,t){var n,r,i,o;return i=k.basename(e,k.extname(e))+".js",o=k.dirname(e),n="."===t?o:o.substring(t.length),r=w.output?k.join(w.output,n):o,k.join(r,i)},R=function(e,t,n){var r,i,o;return o=_(e,n),i=k.dirname(o),r=function(){return 0>=t.length&&(t=" "),f.writeFile(o,t,function(t){return t?E(t.message):w.compile&&w.watch?N("compiled "+e):void 0})},k.exists(i,function(e){return e?r():l("mkdir -p "+i,r)})},$=function(e,t){return setTimeout(t,e)},N=function(e){return console.log(""+(new Date).toLocaleTimeString()+" - "+e)},m=function(e,t){var n,r,i;return i=function(t){return E(e+":	"+(""+t).trim())},n=__dirname+"/../../extras/jsl.conf",r=C("jsl",["-nologo","-stdin","-conf",n]),r.stdout.on("data",i),r.stderr.on("data",i),r.stdin.write(t),r.stdin.end()},q=function(e){var t,n,r,i;return t=function(){var t,o,a,s;for(s=[],t=0,o=e.length;o>t;t++)r=e[t],a=[r[0],(""+r[1]).replace(/\n/,"\\n")],n=a[0],i=a[1],s.push("["+n+" "+i+"]");return s}(),E(t.join(" "))},x=function(){var t,n,i,o,a;for(y=new b.OptionParser(r,e),n=w=y.parse(process.argv.slice(2)),n.compile||(n.compile=!!n.output),n.run=!(n.compile||n.print||n.lint),n.print=!!(n.print||n.eval||n.stdio&&n.compile),j=n.arguments,t=o=0,a=j.length;a>o;t=++o)i=j[t],T[t]=null},o=function(e){return{filename:e,bare:w.bare,header:w.compile}},c=function(){var e,t;return t=w.nodejs.split(/\s+/),e=process.argv.slice(1),e.splice(e.indexOf("--nodejs"),2),C(process.execPath,t.concat(e),{cwd:process.cwd(),env:process.env,customFds:[0,1,2]})},M=function(){return E(new b.OptionParser(r,e).help())},L=function(){return E("CoffeeScript version "+t.VERSION)}}).call(this);