/*
 * typeahead.js
 * https://github.com/twitter/typeahead
 * Copyright 2013 Twitter, Inc. and other contributors; Licensed MIT
 */

var TypeaheadView=function(){function e(e){utils.bindAll(this),this.$node=t(e.input),this.datasets=e.datasets,utils.each(this.datasets,function(e,t){var n='<li class="tt-suggestion">%body</li>';t.template=t.template?t.engine.compile(n.replace("%body",t.template)):{render:function(e){return n.replace("%body","<p>"+e.value+"</p>")}}}),this.inputView=new InputView({input:this.$node.find(".tt-query"),hint:this.$node.find(".tt-hint")}),this.dropdownView=new DropdownView({menu:this.$node.find(".tt-dropdown-menu")}),this.dropdownView.on("select",this._handleSelection).on("cursorOn",this._clearHint).on("cursorOn",this._setInputValueToSuggestionUnderCursor).on("cursorOff",this._setInputValueToQuery).on("cursorOff",this._updateHint).on("suggestionsRender",this._updateHint).on("show",this._updateHint).on("hide",this._clearHint),this.inputView.on("focus",this._showDropdown).on("blur",this._hideDropdown).on("blur",this._setInputValueToQuery).on("enter",this._handleSelection).on("queryChange",this._clearHint).on("queryChange",this._clearSuggestions).on("queryChange",this._getSuggestions).on("whitespaceChange",this._updateHint).on("queryChange whitespaceChange",this._showDropdown).on("queryChange whitespaceChange",this._setLanguageDirection).on("esc",this._hideDropdown).on("esc",this._setInputValueToQuery).on("tab up down",this._managePreventDefault).on("up down",this._moveDropdownCursor).on("up down",this._showDropdown).on("tab left right",this._autocomplete)}function t(e){var t=$(e),r=$(n.hint).css({"background-color":t.css("background-color")});if(0===t.length)return null;try{!t.attr("dir")&&t.attr("dir","auto")}catch(i){}return t.attr({autocomplete:"off",spellcheck:!1}).addClass("tt-query").wrap(n.wrapper).parent().prepend(r).append(n.dropdown)}var n={wrapper:'<span class="twitter-typeahead"></span>',hint:'<input class="tt-hint" type="text" autocomplete="off" spellcheck="false" disabled>',dropdown:'<ol class="tt-dropdown-menu tt-is-empty"></ol>'};return utils.mixin(e.prototype,EventTarget,{_managePreventDefault:function(e){var t,n,r=e.data,i=!1;switch(e.type){case"tab":t=this.inputView.getHintValue(),n=this.inputView.getInputValue(),i=t&&t!==n;break;case"up":case"down":i=!r.shiftKey&&!r.ctrlKey&&!r.metaKey}i&&r.preventDefault()},_setLanguageDirection:function(){var e="tt-"+this.inputView.getLanguageDirection();this.$node.hasClass(e)||this.$node.removeClass("tt-ltr tt-rtl").addClass(e)},_updateHint:function(){var e,t,n,r,i=this.dropdownView.getFirstSuggestion(),o=i?i.value:null;o&&this.dropdownView.isOpen()&&!this.inputView.isOverflow()&&(e=this.inputView.getInputValue(),t=e.replace(/\s{2,}/g," ").replace(/^\s+/g,""),n=RegExp("^(?:"+t+")(.*$)","i"),r=n.exec(o),this.inputView.setHintValue(e+(r?r[1]:"")))},_clearHint:function(){this.inputView.setHintValue("")},_clearSuggestions:function(){this.dropdownView.clearSuggestions()},_setInputValueToQuery:function(){this.inputView.setInputValue(this.inputView.getQuery())},_setInputValueToSuggestionUnderCursor:function(e){var t=e.data;this.inputView.setInputValue(t.value,!0)},_showDropdown:function(){this.dropdownView.show()},_hideDropdown:function(e){this.dropdownView["blur"===e.type?"hideUnlessMouseIsOverDropdown":"hide"]()},_moveDropdownCursor:function(e){var t=e.data;t.shiftKey||t.ctrlKey||t.metaKey||this.dropdownView["up"===e.type?"moveCursorUp":"moveCursorDown"]()},_handleSelection:function(e){var t="select"===e.type,n=t?e.data:this.dropdownView.getSuggestionUnderCursor();n&&(this.inputView.setInputValue(n.value),t?this.inputView.focus():e.data.preventDefault(),t&&utils.isMsie()?setTimeout(this.dropdownView.hide,0):this.dropdownView.hide())},_getSuggestions:function(){var e=this,t=this.inputView.getQuery();utils.each(this.datasets,function(n,r){r.getSuggestions(t,function(n){e._renderSuggestions(t,r,n)})})},_renderSuggestions:function(e,t,n){e===this.inputView.getQuery()&&(n=n.slice(0,t.limit),this.dropdownView.renderSuggestions(e,t,n))},_autocomplete:function(e){var t,n,r,i;("right"!==e.type&&"left"!==e.type||(t=this.inputView.isCursorAtEnd(),n="ltr"===this.inputView.getLanguageDirection()?"left"===e.type:"right"===e.type,t&&!n))&&(r=this.inputView.getQuery(),i=this.inputView.getHintValue(),""!==i&&r!==i&&this.inputView.setInputValue(i))}}),e}();