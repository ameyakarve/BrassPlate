define([],function(){function t(){return""===h.hash||"#"===h.hash}function e(t,e){for(var i=0;t.length>i;i+=1)if(e(t[i],i,t)===!1)return}function i(t){for(var e=[],i=0,n=t.length;n>i;i++)e=e.concat(t[i]);return e}function n(t,e,i){if(!t.length)return i();var n=0;(function o(){e(t[n],function(e){e||e===!1?(i(e),i=function(){}):(n+=1,n===t.length?i():o())})})()}function o(t,e,i){i=t;for(var n in e)if(e.hasOwnProperty(n)&&(i=e[n](t),i!==t))break;return i===t?"([._a-zA-Z0-9-]+)":i}function r(t,e){for(var i,n=0,s="";i=t.substr(n).match(/[^\w\d\- %@&]*\*[^\w\d\- %@&]*/);)n=i.index+i[0].length,i[0]=i[0].replace(/^\*/,"([_.()!\\ %@&a-zA-Z0-9-]+)"),s+=t.substr(0,i.index)+i[0];t=s+=t.substr(n);var r,a=t.match(/:([^\/]+)/gi);if(a){r=a.length;for(var h=0;r>h;h++)t=t.replace(a[h],o(a[h],e))}return t}function a(t,e,i,n){var o,s=0,r=0,a=0,i=""+(i||"("),n=""+(n||")");for(o=0;t.length>o;o++){var h=t[o];if(h.indexOf(i,s)>h.indexOf(n,s)||~h.indexOf(i,s)&&!~h.indexOf(n,s)||!~h.indexOf(i,s)&&~h.indexOf(n,s)){if(r=h.indexOf(i,s),a=h.indexOf(n,s),~r&&!~a||!~r&&~a){var c=t.slice(0,(o||1)+1).join(e);t=[c].concat(t.slice((o||1)+1))}s=(a>r?a:r)+1,o=0}else s=0}return t}Array.prototype.filter||(Array.prototype.filter=function(t,e){for(var i,n=[],o=0,s=this.length;s>o;o++)o in this&&t.call(e,i=this[o],o,this)&&n.push(i);return n}),Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var h=document.location,c={mode:"modern",hash:h.hash,history:!1,check:function(){var t=h.hash;t!=this.hash&&(this.hash=t,this.onHashChanged())},fire:function(){"modern"===this.mode?this.history===!0?window.onpopstate():window.onhashchange():this.onHashChanged()},init:function(t,e){function i(t){for(var e=0,i=l.listeners.length;i>e;e++)l.listeners[e](t)}var n=this;if(this.history=e,l.listeners||(l.listeners=[]),"onhashchange"in window&&(void 0===document.documentMode||document.documentMode>7))this.history===!0?setTimeout(function(){window.onpopstate=i},500):window.onhashchange=i,this.mode="modern";else{var o=document.createElement("iframe");o.id="state-frame",o.style.display="none",document.body.appendChild(o),this.writeFrame(""),"onpropertychange"in document&&"attachEvent"in document&&document.attachEvent("onpropertychange",function(){"location"===event.propertyName&&n.check()}),window.setInterval(function(){n.check()},50),this.onHashChanged=i,this.mode="legacy"}return l.listeners.push(t),this.mode},destroy:function(t){if(l&&l.listeners)for(var e=l.listeners,i=e.length-1;i>=0;i--)e[i]===t&&e.splice(i,1)},setHash:function(t){return"legacy"===this.mode&&this.writeFrame(t),this.history===!0?(window.history.pushState({},document.title,t),this.fire()):h.hash="/"===t[0]?t:"/"+t,this},writeFrame:function(t){var e=document.getElementById("state-frame"),i=e.contentDocument||e.contentWindow.document;i.open(),i.write("<script>_hash = '"+t+"'; onload = parent.listener.syncHash;<script>"),i.close()},syncHash:function(){var t=this._hash;return t!=h.hash&&(h.hash=t),this},onHashChanged:function(){}},l=l=function(t){return this instanceof l?(this.params={},this.routes={},this.methods=["on","once","after","before"],this.scope=[],this._methods={},this._insert=this.insert,this.insert=this.insertEx,this.historySupport=null!=(null!=window.history?window.history.pushState:null),this.configure(),this.mount(t||{}),void 0):new l(t)};return l.prototype.init=function(e){var i=this;if(this.handler=function(t){var e=t&&t.newURL||window.location.hash,n=i.history===!0?i.getPath():e.replace(/.*#/,"");i.dispatch("on",n)},c.init(this.handler,this.history),this.history===!1)t()&&e?h.hash=e:t()||i.dispatch("on",h.hash.replace(/^#/,""));else{var n=t()&&e?e:t()?null:h.hash.replace(/^#/,"");n&&window.history.replaceState({},document.title,n),(n||this.run_in_init===!0)&&this.handler()}return this},l.prototype.explode=function(){var t=this.history===!0?this.getPath():h.hash;return"/"===t.charAt(1)&&(t=t.slice(1)),t.slice(1,t.length).split("/")},l.prototype.setRoute=function(t,e,i){var n=this.explode();return"number"==typeof t&&"string"==typeof e?n[t]=e:"string"==typeof i?n.splice(t,e,s):n=[t],c.setHash(n.join("/")),n},l.prototype.insertEx=function(t,e,i,n){return"once"===t&&(t="on",i=function(t){var e=!1;return function(){return e?void 0:(e=!0,t.apply(this,arguments))}}(i)),this._insert(t,e,i,n)},l.prototype.getRoute=function(t){var e=t;if("number"==typeof t)e=this.explode()[t];else if("string"==typeof t){var i=this.explode();e=i.indexOf(t)}else e=this.explode();return e},l.prototype.destroy=function(){return c.destroy(this.handler),this},l.prototype.getPath=function(){var t=window.location.pathname;return"/"!==t.substr(0,1)&&(t="/"+t),t},l.prototype.configure=function(t){t=t||{};for(var e=0;this.methods.length>e;e++)this._methods[this.methods[e]]=!0;return this.recurse=t.recurse||this.recurse||!1,this.async=t.async||!1,this.delimiter=t.delimiter||"/",this.strict=t.strict===void 0?!0:t.strict,this.notfound=t.notfound,this.resource=t.resource,this.history=t.html5history&&this.historySupport||!1,this.run_in_init=this.history===!0&&t.run_handler_in_init!==!1,this.every={after:t.after||null,before:t.before||null,on:t.on||null},this},l.prototype.param=function(t,e){":"!==t[0]&&(t=":"+t);var i=RegExp(t,"g");this.params[t]=function(t){return t.replace(i,e.source||e)}},l.prototype.on=l.prototype.route=function(t,e,i){var n=this;return i||"function"!=typeof e||(i=e,e=t,t="on"),Array.isArray(e)?e.forEach(function(e){n.on(t,e,i)}):(e.source&&(e=e.source.replace(/\\\//gi,"/")),Array.isArray(t)?t.forEach(function(t){n.on(t.toLowerCase(),e,i)}):(e=e.split(RegExp(this.delimiter)),e=a(e,this.delimiter),this.insert(t,this.scope.concat(e),i),void 0))},l.prototype.dispatch=function(t,e,i){function n(){s.last=r.after,s.invoke(s.runlist(r),s,i)}var o,s=this,r=this.traverse(t,e,this.routes,""),a=this._invoked;return this._invoked=!0,r&&0!==r.length?("forward"===this.recurse&&(r=r.reverse()),o=this.every&&this.every.after?[this.every.after].concat(this.last):[this.last],o&&o.length>0&&a?(this.async?this.invoke(o,this,n):(this.invoke(o,this),n()),!0):(n(),!0)):(this.last=[],"function"==typeof this.notfound&&this.invoke([this.notfound],{method:t,path:e},i),!1)},l.prototype.invoke=function(t,i,o){var s=this;this.async?n(t,function r(e,o){return Array.isArray(e)?n(e,r,o):("function"==typeof e&&e.apply(i,t.captures.concat(o)),void 0)},function(){o&&o.apply(i,arguments)}):e(t,function r(n){return Array.isArray(n)?e(n,r):"function"==typeof n?n.apply(i,t.captures||[]):("string"==typeof n&&s.resource&&s.resource[n].apply(i,t.captures||[]),void 0)})},l.prototype.traverse=function(t,e,i,n,o){function s(t){function e(t){for(var i=[],n=0;t.length>n;n++)i[n]=Array.isArray(t[n])?e(t[n]):t[n];return i}function i(t){for(var e=t.length-1;e>=0;e--)Array.isArray(t[e])?(i(t[e]),0===t[e].length&&t.splice(e,1)):o(t[e])||t.splice(e,1)}if(!o)return t;var n=e(t);return n.matched=t.matched,n.captures=t.captures,n.after=t.after.filter(o),i(n),n}var r,a,h,c,l=[];if(e===this.delimiter&&i[t])return c=[[i.before,i[t]].filter(Boolean)],c.after=[i.after].filter(Boolean),c.matched=!0,c.captures=[],s(c);for(var u in i)if(i.hasOwnProperty(u)&&(!this._methods[u]||this._methods[u]&&"object"==typeof i[u]&&!Array.isArray(i[u]))){if(r=a=n+this.delimiter+u,this.strict||(a+="["+this.delimiter+"]?"),h=e.match(RegExp("^"+a)),!h)continue;if(h[0]&&h[0]==e&&i[u][t])return c=[[i[u].before,i[u][t]].filter(Boolean)],c.after=[i[u].after].filter(Boolean),c.matched=!0,c.captures=h.slice(1),this.recurse&&i===this.routes&&(c.push([i.before,i.on].filter(Boolean)),c.after=c.after.concat([i.after].filter(Boolean))),s(c);if(c=this.traverse(t,e,i[u],r),c.matched)return c.length>0&&(l=l.concat(c)),this.recurse&&(l.push([i[u].before,i[u].on].filter(Boolean)),c.after=c.after.concat([i[u].after].filter(Boolean)),i===this.routes&&(l.push([i.before,i.on].filter(Boolean)),c.after=c.after.concat([i.after].filter(Boolean)))),l.matched=!0,l.captures=c.captures,l.after=c.after,s(l)}return!1},l.prototype.insert=function(t,e,i,n){var o,s,a,h,c;if(e=e.filter(function(t){return t&&t.length>0}),n=n||this.routes,c=e.shift(),/\:|\*/.test(c)&&!/\\d|\\w/.test(c)&&(c=r(c,this.params)),e.length>0)return n[c]=n[c]||{},this.insert(t,e,i,n[c]);if(c||e.length||n!==this.routes){if(s=typeof n[c],a=Array.isArray(n[c]),n[c]&&!a&&"object"==s)switch(o=typeof n[c][t]){case"function":return n[c][t]=[n[c][t],i],void 0;case"object":return n[c][t].push(i),void 0;case"undefined":return n[c][t]=i,void 0}else if("undefined"==s)return h={},h[t]=i,n[c]=h,void 0;throw Error("Invalid route context: "+s)}switch(o=typeof n[t]){case"function":return n[t]=[n[t],i],void 0;case"object":return n[t].push(i),void 0;case"undefined":return n[t]=i,void 0}},l.prototype.extend=function(t){function e(t){n._methods[t]=!0,n[t]=function(){var e=1===arguments.length?[t,""]:[t];n.on.apply(n,e.concat(Array.prototype.slice.call(arguments)))}}var i,n=this,o=t.length;for(i=0;o>i;i++)e(t[i])},l.prototype.runlist=function(t){var e=this.every&&this.every.before?[this.every.before].concat(i(t)):i(t);return this.every&&this.every.on&&e.push(this.every.on),e.captures=t.captures,e.source=t.source,e},l.prototype.mount=function(t,e){function i(e,i){var o=e,s=e.split(n.delimiter),r=typeof t[e],h=""===s[0]||!n._methods[s[0]],c=h?"on":o;return h&&(o=o.slice((o.match(RegExp(n.delimiter))||[""])[0].length),s.shift()),h&&"object"===r&&!Array.isArray(t[e])?(i=i.concat(s),n.mount(t[e],i),void 0):(h&&(i=i.concat(o.split(n.delimiter)),i=a(i,n.delimiter)),n.insert(c,i,t[e]),void 0)}if(t&&"object"==typeof t&&!Array.isArray(t)){var n=this;e=e||[],Array.isArray(e)||(e=e.split(n.delimiter));for(var o in t)t.hasOwnProperty(o)&&i(o,e.slice(0))}},{Router:l}});