// ==========================================
// Copyright 2013 Twitter, Inc
// Licensed under The MIT License
// http://opensource.org/licenses/MIT
// ==========================================

define(["./advice","./utils","./compose","./registry"],function(e,t,n,r){function i(e){e.events.slice().forEach(function(e){var t=[e.type];e.element&&t.unshift(e.element),"function"==typeof e.callback&&t.push(e.callback),this.off.apply(this,t)},e.instance)}function o(){this.trigger("componentTearDown"),i(r.findInstanceInfo(this))}function s(){var e=r.findComponentInfo(this);e&&e.instances.slice().forEach(function(e){e.instance.teardown()})}function a(e,t){try{window.postMessage(t,"*")}catch(n){throw console.log("unserializable data for event",e,":",t),Error(["The event",e,"on component",this.describe,"was triggered with non-serializable data"].join(" "))}}function u(){this.trigger=function(){var e,n,r,i,o,s=t.toArray(arguments),u=s[s.length-1];"string"==typeof u||u&&u.defaultBehavior||(r=s.pop()),e=2==s.length?$(s.shift()):this.$node,i=s[0],i.defaultBehavior&&(o=i.defaultBehavior,i=$.Event(i.type)),n=i.type||i,window.DEBUG&&window.postMessage&&a.call(this,n,r),"object"==typeof this.attr.eventData&&(r=$.extend(!0,{},this.attr.eventData,r));var l=e.trigger(i||n,r);return o&&!i.isDefaultPrevented()&&(this[o]||o).call(this),l},this.on=function(){var e,n,r,i,o=t.toArray(arguments);if(i="object"==typeof o[o.length-1]?t.delegate(this.resolveDelegateRules(o.pop())):o.pop(),e=2==o.length?$(o.shift()):this.$node,n=o[0],"function"!=typeof i&&"object"!=typeof i)throw Error("Unable to bind to '"+n+"' because the given callback is not a function or an object");return r=i.bind(this),r.target=i,i.guid&&(r.guid=i.guid),e.on(n,r),i.guid=r.guid,r},this.off=function(){var e,n,r,i=t.toArray(arguments);return"function"==typeof i[i.length-1]&&(r=i.pop()),e=2==i.length?$(i.shift()):this.$node,n=i[0],e.off(n,r)},this.resolveDelegateRules=function(e){var t={};return Object.keys(e).forEach(function(n){if(!this.attr.hasOwnProperty(n))throw Error('Component "'+this.describe+'" wants to listen on "'+n+'" but no such attribute was defined.');t[this.attr[n]]=e[n]},this),t},this.defaultAttrs=function(e){t.push(this.defaults,e,!0)||(this.defaults=e)},this.select=function(e){return this.$node.find(this.attr[e])},this.initialize=$.noop,this.teardown=o}function l(e){if(!e)throw Error("Component needs to be attachTo'd a jQuery object, native node or selector string");var n=t.merge.apply(t,t.toArray(arguments,1));$(e).each(function(e,t){new this(t,n)}.bind(this))}function c(){function i(e,n){var r={},i=0;if(!e)throw Error("Component needs a node");e.jquery?(this.node=e[0],this.$node=e):(this.node=e,this.$node=$(e)),this.describe=this.constructor.describe,this.bind=function(e){var n;if(e.uuid&&(n=r[e.uuid]))return n;var o=t.toArray(arguments,1);return o.unshift(this),n=e.bind.apply(e,o),n.target=e,e.uuid=i++,r[e.uuid]=n,n},this.attr=t.merge(this.defaults,n),this.defaults&&Object.keys(this.defaults).forEach(function(e){if(null===this.defaults[e]&&null===this.attr[e])throw Error('Required attribute "'+e+'" not specified in attachTo for component "'+this.describe+'".')},this),this.initialize.call(this,n||{}),this.trigger("componentInitialized")}var o=t.toArray(arguments);return i.toString=function(){var e=o.map(function(e){if($.browser.msie){var t=(""+e).match(f);return t&&t[1]?t[1]:""}return e.name}).join(", ").replace(p,"");return e},i.describe=""+i,i.attachTo=l,i.teardownAll=s,o.unshift(u,e.withAdvice,r.withRegistration),n.mixin(i.prototype,o),i}var f=/function (.*?)\s?\(/,p=/\s\,/g;return c.teardownAll=function(){r.components.slice().forEach(function(e){e.component.teardownAll()}),r.reset()},c});