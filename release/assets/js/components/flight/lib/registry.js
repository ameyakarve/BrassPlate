// ==========================================
// Copyright 2013 Twitter, Inc
// Licensed under The MIT License
// http://opensource.org/licenses/MIT
// ==========================================

define(["./utils"],function(e){function t(t,n){var r,i,o;return n=e.toArray(n),"function"==typeof n[n.length-1]&&(o=n.pop()),"object"==typeof n[n.length-1]&&n.pop(),2==n.length?(r=n[0],i=n[1]):(r=t.node,i=n[0]),{element:r,type:i,callback:o}}function n(e,t){return e.element==t.element&&e.type==t.type&&(null==t.callback||e.callback==t.callback)}function r(){function r(e){this.component=e,this.instances=[],this.addInstance=function(e){this.throwIfInstanceExistsOnNode(e);var t=new i(e);return this.instances.push(t),t},this.throwIfInstanceExistsOnNode=function(e){this.instances.forEach(function(t){if(t.instance.$node[0]===e.$node[0])throw Error("Instance of "+e.constructor+" already exists on node "+e.$node[0])})},this.removeInstance=function(e){var t=this.instances.filter(function(t){return t.instance==e})[0],n=this.instances.indexOf(t);n>-1&&this.instances.splice(n,1),this.instances.length||o.removeComponentInfo(this)}}function i(e){this.instance=e,this.events=[],this.addTrigger=function(){},this.addBind=function(e){this.events.push(e),o.events.push(e)},this.removeBind=function(e){for(var t,r=0;t=this.events[r];r++)n(t,e)&&this.events.splice(r,1)}}var o=this;(this.reset=function(){this.components=[],this.allInstances=[],this.events=[]}).call(this),this.addInstance=function(e){var t=this.findComponentInfo(e);t||(t=new r(e.constructor),this.components.push(t));var n=t.addInstance(e);return this.allInstances.push(n),t},this.removeInstance=function(e){var t,n=this.findInstanceInfo(e),r=this.findComponentInfo(e);r.removeInstance(e);var t=this.allInstances.indexOf(n);t>-1&&this.allInstances.splice(t,1)},this.removeComponentInfo=function(e){var t=this.components.indexOf(e);t>-1&&this.components.splice(t,1)},this.findComponentInfo=function(e){for(var t,n=e.attachTo?e:e.constructor,r=0;t=this.components[r];r++)if(t.component===n)return t;return null},this.findInstanceInfo=function(e){var t;t=e.node?function(t){return t.instance===e}:function(t){return t.instance.node===e};var n=this.allInstances.filter(t);return n.length?e.node?n[0]:n:e.node?null:[]},this.trigger=function(){var e=t(this,arguments),n=o.findInstanceInfo(this);n&&n.addTrigger(e)},this.on=function(n){var r,i=e.toArray(arguments,1),s=o.findInstanceInfo(this);if(s){r=n.apply(null,i),r&&(i[i.length-1]=r);var a=t(this,i);s.addBind(a)}},this.off=function(){var e=t(this,arguments),n=o.findInstanceInfo(this);n&&n.removeBind(e)},this.teardown=function(){o.removeInstance(this)},this.withRegistration=function(){this.before("initialize",function(){o.addInstance(this)}),this.after("trigger",o.trigger),this.around("on",o.on),this.after("off",o.off),this.after("teardown",{obj:o,fnName:"teardown"})}}return new r});